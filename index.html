<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulateur Classe Flexible - Mission Coop√©rative</title>
<style>
:root {
  --primary: #1a4d6d;
  --secondary: #2e7d9a;
  --accent: #4ba3c3;
  --light-accent: #7cc5d9;
  --success: #5ba58a;
  --warning: #d4a850;
  --danger: #c47466;
  --light: #e8f4f8;
  --lighter: #f5f9fb;
  --dark: #1a4d6d;
  --text: #2d3748;
  --border: #c2d9e3;
}

* { box-sizing: border-box; }

body { 
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
  background: linear-gradient(135deg, #2e7d9a 0%, #4ba3c3 50%, #7cc5d9 100%);
  color: var(--text); 
  margin:0; 
  padding:20px; 
  font-size: 16px;
  line-height: 1.6;
  min-height: 100vh;
}

.container { 
  max-width: 900px; 
  margin: auto; 
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.intro-screen {
  text-align: center;
  padding: 40px 20px;
}

.intro-screen h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.intro-screen .welcome-text {
  background: var(--lighter);
  padding: 30px;
  border-radius: 15px;
  margin: 30px 0;
  border-left: 5px solid var(--accent);
  text-align: left;
  line-height: 1.9;
  font-size: 1.1em;
}

.intro-screen .start-btn {
  background: linear-gradient(135deg, var(--success), #4a9178);
  color: white;
  border: none;
  padding: 20px 50px;
  font-size: 1.4em;
  font-weight: 700;
  border-radius: 15px;
  cursor: pointer;
  margin-top: 30px;
  box-shadow: 0 8px 25px rgba(91, 165, 138, 0.4);
  transition: all 0.3s ease;
}

.intro-screen .start-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(91, 165, 138, 0.5);
}

.mode-selector {
  display: flex;
  gap: 30px;
  justify-content: center;
  margin: 30px 0;
  flex-wrap: wrap;
}

.mode-card {
  background: white;
  border: 3px solid var(--secondary);
  border-radius: 15px;
  padding: 30px;
  width: 320px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.mode-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(46, 125, 154, 0.3);
  border-color: var(--accent);
}

.mode-card.selected {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  border-color: var(--light-accent);
}

.mode-card h3 {
  margin-top: 0;
  font-size: 1.5em;
}

.mode-card .icon {
  font-size: 3.5em;
  margin-bottom: 15px;
}

.mode-card ul {
  text-align: left;
  margin-top: 15px;
  font-size: 0.95em;
}

.walkie-alert {
  background: linear-gradient(135deg, var(--warning), #c9a04d);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  animation: pulseAlert 2s infinite;
  box-shadow: 0 8px 25px rgba(212, 168, 80, 0.4);
  border: 3px solid var(--warning);
}

@keyframes pulseAlert {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.85; transform: scale(1.02); }
}

.walkie-alert h4 {
  margin-top: 0;
  font-size: 1.3em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.walkie-alert .icon {
  font-size: 1.8em;
  animation: shake 0.5s infinite;
}

@keyframes shake {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}

.pilot-exclusive {
  background: var(--lighter);
  padding: 25px;
  border-radius: 15px;
  margin: 20px 0;
  border: 3px solid var(--accent);
  box-shadow: 0 8px 25px rgba(75, 163, 195, 0.2);
}

.pilot-exclusive h4 {
  color: var(--primary);
  margin-top: 0;
  font-size: 1.3em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.pilot-exclusive .hint-box {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin: 15px 0;
  border-left: 5px solid var(--accent);
}

.pilot-exclusive .hint-emphasis {
  background: var(--light);
  padding: 15px;
  border-radius: 10px;
  font-family: 'Courier New', monospace;
  font-size: 1.1em;
  margin: 15px 0;
  border: 2px dashed var(--secondary);
  color: var(--primary);
  font-weight: 600;
}

.timer-container {
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  padding: 20px;
  border-radius: 15px;
  margin: 20px 0;
  text-align: center;
  box-shadow: 0 8px 25px rgba(46, 125, 154, 0.4);
}

.timer-display {
  font-size: 3em;
  font-weight: 700;
  margin: 15px 0;
  font-family: 'Courier New', monospace;
}

.timer-bar {
  width: 100%;
  height: 20px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 15px;
}

.timer-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
  transition: width 1s linear;
}

.timer-warning {
  background: linear-gradient(135deg, var(--warning), #c9a04d);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.bonus-time-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.bonus-time-content {
  background: white;
  padding: 40px;
  border-radius: 20px;
  max-width: 500px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.bonus-time-content h2 {
  color: var(--warning);
  margin-top: 0;
  font-size: 2em;
}

.bonus-time-content .icon {
  font-size: 4em;
  margin: 20px 0;
}

.bonus-time-content .buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
}

.bonus-time-content button {
  padding: 15px 30px;
  font-size: 1.1em;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.bonus-time-content .accept-btn {
  background: linear-gradient(135deg, var(--success), #4a9178);
  color: white;
}

.bonus-time-content .accept-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(91, 165, 138, 0.4);
}

.bonus-time-content .decline-btn {
  background: #e0e0e0;
  color: var(--text);
}

.bonus-time-content .decline-btn:hover {
  background: #d0d0d0;
}

.letters-header {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 20px;
  border-radius: 15px;
  margin: 20px 0;
  text-align: center;
  box-shadow: 0 8px 25px rgba(26, 77, 109, 0.3);
}

.letters-header h3 {
  margin: 0 0 15px 0;
  font-size: 1.3em;
}

.letters {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
}

.letter {
  width: 60px;
  height: 60px;
  background: white;
  color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2em;
  font-weight: 700;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  animation: letterPop 0.5s ease;
}

@keyframes letterPop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.code-display {
  background: var(--lighter);
  padding: 30px;
  border-radius: 15px;
  margin: 25px 0;
  border: 3px solid var(--accent);
}

.success-message {
  text-align: center;
  padding: 40px 20px;
}

.success-message h3 {
  color: var(--success);
  font-size: 2em;
  margin-bottom: 30px;
}

.continue-btn {
  background: linear-gradient(135deg, var(--accent), var(--light-accent));
  color: white;
  border: none;
  padding: 18px 45px;
  font-size: 1.3em;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  margin-top: 25px;
  box-shadow: 0 8px 25px rgba(75, 163, 195, 0.4);
  transition: all 0.3s ease;
}

.continue-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(75, 163, 195, 0.5);
}

.back-btn {
  background: #e0e0e0;
  color: var(--text);
  border: none;
  padding: 12px 25px;
  font-size: 1em;
  border-radius: 10px;
  cursor: pointer;
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.back-btn:hover {
  background: #d0d0d0;
  transform: translateX(-3px);
}

.resources {
  background: var(--lighter);
  padding: 25px;
  border-radius: 15px;
  margin: 20px 0;
  border-left: 5px solid var(--success);
}

.resources h3 {
  color: var(--primary);
  margin-top: 0;
}

.resources a {
  color: var(--secondary);
  text-decoration: none;
  font-weight: 600;
  display: inline-block;
  margin-top: 15px;
  padding: 12px 25px;
  background: white;
  border-radius: 10px;
  transition: all 0.3s ease;
  border: 2px solid var(--secondary);
}

.resources a:hover {
  background: var(--secondary);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(46, 125, 154, 0.3);
}

.keyword-input {
  background: white;
  padding: 25px;
  border-radius: 15px;
  margin: 25px 0;
  border: 3px solid var(--warning);
  box-shadow: 0 6px 20px rgba(212, 168, 80, 0.2);
}

.keyword-input h4 {
  color: var(--warning);
  margin-top: 0;
  font-size: 1.3em;
}

.keyword-hint {
  font-size: 0.9em;
  color: #7F8C8D;
  font-style: italic;
  margin: 10px 0;
}

.keyword-input input[type="text"] {
  width: 100%;
  padding: 15px;
  font-size: 1.1em;
  border: 2px solid var(--border);
  border-radius: 10px;
  margin: 15px 0;
  transition: all 0.3s ease;
}

.keyword-input input[type="text"]:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(75, 163, 195, 0.2);
}

.keyword-input button {
  background: linear-gradient(135deg, var(--warning), #c9a04d);
  color: white;
  border: none;
  padding: 15px 35px;
  font-size: 1.1em;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px rgba(212, 168, 80, 0.3);
}

.keyword-input button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(212, 168, 80, 0.4);
}

.discussion-box {
  background: var(--light);
  padding: 25px;
  border-radius: 15px;
  margin: 20px 0;
  border-left: 5px solid var(--accent);
}

.discussion-box h4 {
  color: var(--primary);
  margin-top: 0;
}

.qcm {
  background: white;
  padding: 25px;
  border-radius: 15px;
  margin: 25px 0;
  border: 3px solid var(--accent);
}

.qcm label {
  display: block;
  padding: 15px;
  margin: 10px 0;
  background: var(--lighter);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.qcm label:hover {
  background: var(--light);
  border-color: var(--accent);
  transform: translateX(5px);
}

.qcm input[type="checkbox"] {
  margin-right: 12px;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.qcm button {
  background: linear-gradient(135deg, var(--accent), var(--light-accent));
  color: white;
  border: none;
  padding: 15px 40px;
  font-size: 1.1em;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px rgba(75, 163, 195, 0.3);
}

.qcm button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(75, 163, 195, 0.4);
}

.qcm button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.dragspace {
  background: var(--lighter);
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  min-height: 80px;
  border: 2px dashed var(--border);
}

.dragspace.single {
  background: white;
  border: 3px solid var(--accent);
  min-height: 100px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.draggable {
  display: inline-block;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  color: white;
  padding: 12px 20px;
  margin: 8px;
  border-radius: 10px;
  cursor: move;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(46, 125, 154, 0.3);
  transition: all 0.3s ease;
}

.draggable:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(46, 125, 154, 0.4);
}

.steps-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 25px 0;
}

.button-group {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 25px;
  flex-wrap: wrap;
}

.button-group button {
  padding: 15px 35px;
  font-size: 1.1em;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.reset-btn {
  background: #e0e0e0;
  color: var(--text);
}

.reset-btn:hover {
  background: #d0d0d0;
  transform: translateY(-2px);
}

.pilot-interface {
  background: white;
  padding: 30px;
  border-radius: 15px;
  margin: 25px 0;
  border: 3px solid var(--primary);
  box-shadow: 0 8px 25px rgba(26, 77, 109, 0.3);
}

.pilot-interface h3 {
  color: var(--primary);
  margin-top: 0;
  text-align: center;
  font-size: 1.5em;
}

.code-input-group {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 25px 0;
}

.code-input {
  width: 80px;
  height: 80px;
  font-size: 3em;
  text-align: center;
  border: 3px solid var(--accent);
  border-radius: 12px;
  font-weight: 700;
  color: var(--primary);
  text-transform: uppercase;
  transition: all 0.3s ease;
}

.code-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(26, 77, 109, 0.2);
  transform: scale(1.05);
}

.pilot-interface button {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  padding: 18px 45px;
  font-size: 1.3em;
  font-weight: 700;
  border-radius: 12px;
  cursor: pointer;
  display: block;
  margin: 0 auto;
  box-shadow: 0 8px 25px rgba(26, 77, 109, 0.4);
  transition: all 0.3s ease;
}

.pilot-interface button:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(26, 77, 109, 0.5);
}

#scoring {
  background: var(--lighter);
  padding: 25px;
  border-radius: 15px;
  margin: 25px 0;
  border-left: 5px solid var(--success);
  line-height: 2;
}

#notes {
  width: 100%;
  min-height: 120px;
  padding: 15px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 1em;
  font-family: inherit;
  margin: 15px 0;
  resize: vertical;
}

#notes:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(75, 163, 195, 0.2);
}

.notes-section {
  background: var(--lighter);
  padding: 25px;
  border-radius: 15px;
  margin: 25px 0;
  border: 3px solid var(--accent);
}

.notes-section h3 {
  color: var(--primary);
  margin-top: 0;
}

button {
  font-family: inherit;
}

img {
  max-width: 100%;
  height: auto;
  border-radius: 12px;
  margin: 20px 0;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* R√©v√©lation finale am√©lior√©e */
.final-reveal {
  text-align: center;
  padding: 40px 20px;
}

.final-reveal h2 {
  font-size: 2.8em;
  background: linear-gradient(135deg, var(--success), #4a9178);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 30px;
  animation: fadeInDown 0.8s ease;
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.code-word-display {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 40px;
  border-radius: 20px;
  margin: 30px 0;
  box-shadow: 0 15px 50px rgba(26, 77, 109, 0.4);
  animation: scaleIn 0.8s ease;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.code-word-display .code-word {
  font-size: 4em;
  font-weight: 900;
  letter-spacing: 0.2em;
  margin: 20px 0;
  text-shadow: 0 4px 15px rgba(0,0,0,0.3);
  animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
  0%, 100% {
    text-shadow: 0 0 20px rgba(255,255,255,0.3), 0 0 30px rgba(255,255,255,0.2);
  }
  50% {
    text-shadow: 0 0 30px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3);
  }
}

.reward-box {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #fff;
  padding: 35px;
  border-radius: 20px;
  margin: 30px 0;
  box-shadow: 0 15px 50px rgba(255, 215, 0, 0.4);
  animation: pulseReward 2s ease-in-out infinite;
}

@keyframes pulseReward {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 15px 50px rgba(255, 215, 0, 0.4);
  }
  50% {
    transform: scale(1.02);
    box-shadow: 0 20px 60px rgba(255, 215, 0, 0.6);
  }
}

.reward-box .trophy {
  font-size: 5em;
  margin-bottom: 15px;
  animation: bounce 1s ease infinite;
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-15px);
  }
}

.reward-box h3 {
  font-size: 2.2em;
  margin: 15px 0;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.reward-box .note-reveal {
  font-size: 1.8em;
  font-weight: 700;
  margin: 20px 0;
  background: rgba(255,255,255,0.2);
  padding: 20px;
  border-radius: 15px;
  backdrop-filter: blur(10px);
}

.position-badge {
  display: inline-block;
  background: white;
  color: #FFA500;
  padding: 15px 35px;
  border-radius: 50px;
  font-size: 1.5em;
  font-weight: 900;
  margin: 15px 0;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<div class="container">
  <div id="app">
    <div class="intro-screen">
      <h1>üéØ Simulateur Classe Flexible</h1>
      <div class="welcome-text">
        <p><strong>Bienvenue dans cette mission coop√©rative !</strong></p>
        <p>Vous allez travailler en √©quipe pour d√©couvrir les cl√©s d'une transformation r√©ussie vers la classe flexible.</p>
        <p><strong>Objectif :</strong> D√©bloquer les 6 lettres du code secret en r√©solvant des d√©fis collectifs.</p>
        <p><strong>Dur√©e :</strong> 25 minutes chrono ‚è±Ô∏è</p>
        <p><strong>Important :</strong> Choisissez votre mode de jeu avant de commencer !</p>
      </div>
      
      <h2 style="margin-top: 40px;">Choisissez votre mode de jeu</h2>
      <div class="mode-selector">
        <div class="mode-card" onclick="selectMode('pilot')">
          <div class="icon">üì±</div>
          <h3>Mode Pilote</h3>
          <p><strong>Vous avez des ressources papier !</strong></p>
          <ul>
            <li>Consultez vos documents physiques</li>
            <li>Trouvez les codes secrets</li>
            <li>Guidez votre √©quipe via talkie-walkie</li>
          </ul>
        </div>
        
        <div class="mode-card" onclick="selectMode('reader')">
          <div class="icon">üíª</div>
          <h3>Mode Lecteur/Chercheur</h3>
          <p><strong>Vous explorez les ressources en ligne !</strong></p>
          <ul>
            <li>Lisez les articles et vid√©os</li>
            <li>R√©pondez aux questions</li>
            <li>Communiquez avec le Pilote</li>
          </ul>
        </div>
      </div>
      
      <button class="start-btn" onclick="startGame()">üöÄ Lancer la mission</button>
    </div>
  </div>
</div>

<script>
let state = {
  mode: localStorage.getItem('classFlexMode') || null,
  step: 0,
  score: 0,
  letters: [],
  parcours: [],
  xp: 0,
  timeRemaining: 1500,
  timerStarted: false,
  bonusRequested: false,
  exportID: null
};

const pilotHints = [
  {step: 0, alert: "üìª Le Pilote doit consulter sa ressource papier pour trouver un indice important !", hint: "Sur votre fiche papier, section 'Am√©nagement et bien-√™tre' : Cherchez ce qu'un am√©nagement flexible peut r√©duire chez les √©l√®ves. C'est un √©tat √©motionnel n√©gatif en 2 mots.", clue: "üí° Indice : Cela commence par 'le s...' et concerne les √©motions"},
  {step: 1, alert: "üìª Le Pilote a acc√®s √† un sch√©ma exclusif sur ses documents !", hint: "Dans votre document papier 'Organisation du projet' : Identifiez l'outil de planification du 1er degr√© utile au 2nd degr√© aussi. C'est un document avec 4 mots.", clue: "üí° Indice : 'le plan de ...' (compl√©tez avec 2 mots)"},
  {step: 2, alert: "üìª Le Pilote doit v√©rifier une information cruciale !", hint: "Consultez vos ressources papier sur le t√©moignage d'Am√©lie, enseignante de lettres. Elle donne un conseil sur les changements p√©dagogiques. Faut-il TOUT changer ?", clue: "üí° Indice : La r√©ponse est 'oui' ou 'non' (3 lettres)"},
  {step: 3, alert: "üìª Le Pilote a une photo exclusive dans ses documents !", hint: "Dans l'article Archiclasse (section t√©moignage d'Anne-C√©cile Call√©jon) : Trouvez le sport utilis√© comme m√©taphore du travail d'√©quipe. C'est un sport d'hiver en 2 mots.", clue: "üí° Indice : 'le c...' - sport o√π on balaye la glace"},
  {step: 4, alert: "üìª Le Pilote doit analyser un cas pratique sur sa fiche !", hint: "Dans votre document 'Gestion des nuisances et BEP' : Identifiez ce que le professeur laisse √† l'√©l√®ve BEP concernant son espace de travail (2 mots).", clue: "üí° Indice : 'le c...' de quelque chose (autonomie de d√©cision)"},
  {step: 5, alert: "üìª Derni√®re mission pour le Pilote !", hint: "Document sur la posture de l'enseignant : Comment D√©fine organise la r√©partition des √©l√®ves sur diff√©rentes assises ? Par un planning de quelle dur√©e ? (1 mot)", clue: "üí° Indice : Commence par 'h...' (7 jours)"}
];

const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(frequency, duration) {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  oscillator.frequency.value = frequency;
  oscillator.type = 'sine';
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration/1000);
}

function playSuccessSound() {
  playBeep(523, 100);
  setTimeout(() => playBeep(659, 100), 100);
  setTimeout(() => playBeep(784, 200), 200);
}

function playWarningSound() {
  playBeep(400, 300);
  setTimeout(() => playBeep(400, 300), 350);
}

function playErrorSound() {
  playBeep(200, 500);
}

function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

const steps = [
  {titre:"Sensibiliser l'√©quipe", xpReward: 100, keyword: {question: "Qu'est-ce qu'un am√©nagement de classe flexible peut tendre √† r√©duire chez les √©l√®ves ?", hint: "(2 mots attendus)", answer: "le stress"}, resources: {title: "üìö Ressource √† consulter", intro: "Avant de r√©pondre, consultez cette ressource sur l'importance de l'am√©nagement de classe :", link: {url:"https://www.reseau-canope.fr/actualites/article/amenager-sa-classe-pour-servir-sa-pedagogie", text:"Am√©nager sa classe pour servir sa p√©dagogie (R√©seau Canop√©)"}}, texte:"Un enseignant refuse de bouger les tables de sa classe et remet en cause l'int√©r√™t de la flexibilit√©. Quel argument est le plus efficace pour engager le dialogue ?", qcm: [{text:"¬´ La classe flexible est grav√©e dans le marbre, c'est un projet sp√©cifique. ¬ª", correct:false}, {text:"¬´ La flexibilit√© favorise la collaboration et l'engagement des √©l√®ves. ¬ª", correct:true}, {text:"¬´ On doit suivre la tendance, c'est le XXIe si√®cle ! ¬ª", correct:false}], visuel:"https://cdn.pixabay.com/photo/2017/01/10/19/05/classroom-1963759_960_720.jpg"},
  {titre:"Organiser le projet", xpReward: 100, keyword: {question: "Dans le premier degr√©, quel outil pour planifier les t√¢ches des √©l√®ves peut √™tre utile dans le second degr√© aussi ?", hint: "(4 mots attendus)", answer: "le plan de travail"}, resources: {title: "üìö Ressource √† consulter", intro: "Consultez cette ressource pour comprendre les √©tapes d'un projet de classe flexible :", link: {url:"https://bloghoptoys.fr/comment-reussir-votre-projet-de-classe-flexible/", text:"Comment r√©ussir votre projet de classe flexible ? (Blog Hop'Toys)"}}, texte:"Organisez les √©tapes de d√©marrage d'une classe flexible dans l'ordre chronologique. Glissez chaque √©l√©ment dans la bonne position (une seule carte par √©tape).", dragtask: {items: [{id:"1", text:"R√©fl√©chir au projet et d√©finir les objectifs p√©dagogiques", cat:"etape1"}, {id:"2", text:"Former l'√©quipe et mobiliser les enseignants", cat:"etape2"}, {id:"3", text:"R√©cup√©rer ou acheter du mat√©riel au fur et √† mesure", cat:"etape3"}, {id:"4", text:"Am√©nager la classe avec diff√©rentes zones", cat:"etape4"}, {id:"5", text:"√âtablir des r√®gles claires avec les √©l√®ves", cat:"etape5"}, {id:"6", text:"Observer et ajuster progressivement", cat:"etape6"}, {id:"7", text:"Acheter du mat√©riel sans concertation", cat:"piege"}, {id:"8", text:"Tout changer d'un coup sans test", cat:"piege"}], cats: [{name: "√âtape 1", key:"etape1"}, {name: "√âtape 2", key:"etape2"}, {name: "√âtape 3", key:"etape3"}, {name: "√âtape 4", key:"etape4"}, {name: "√âtape 5", key:"etape5"}, {name: "√âtape 6", key:"etape6"}]}, visuel:"https://images.unsplash.com/photo-1523580846011-d3a5bc25702b"},
  {titre:"Utilit√© p√©dagogique", xpReward: 100, keyword: {question: "Quel est le conseil d'Am√©lie, l'enseignante de lettres pour se lancer : doit-on tout changer dans sa p√©dagogie ?", hint: "(r√©ponse : oui ou non)", answer: "non"}, discussion: "üí¨ Apr√®s avoir visionn√© cette vid√©o, discutez des points ensemble; ensuite parlez avec les membres du groupe pilote pour qu'ils prennent connaissance du contenu de la vid√©o qu'ils n'ont pas vue. Par exemple, quels sont vos ressentis face √† la pr√©sentation de la classe d'Am√©lie.", resources: {title: "üìö Ressource √† consulter (vid√©o)", intro: "D√©couvrez les b√©n√©fices p√©dagogiques de la classe flexible :", link: {url:"https://canotech.fr/a/la-classe-flexible-pour-faire-classe-a-tous-les-eleves", text:"La classe flexible pour faire classe √† tous les √©l√®ves (CanoTech)"}}, texte:"Cochez les avantages p√©dagogiques document√©s de la classe flexible :", qcm: [{text:"Plus grande motivation des √©l√®ves", correct:true}, {text:"Meilleur climat de classe", correct:true}, {text:"Automaticit√© des r√©sultats √©lev√©s", correct:false}, {text:"Favorise l'autonomie", correct:true}, {text:"Les √©l√®ves ne font plus de bruit", correct:false}], visuel:"https://cdn.pixabay.com/photo/2017/09/09/21/13/class-2732253_960_720.jpg"},
  {titre:"Parent inquiet", xpReward: 100, keyword: {question: "Dans l'article d'Archiclasse, dans la partie t√©moignage d'Anne-C√©cile Call√©jon, quel sport est utilis√© pour cr√©er la m√©taphore du travail d'√©quipe ?", hint: "(2 mots attendus)", answer: "le curling"}, resources: {title: "üìö Ressource √† consulter", intro: "D√©couvrez comment impliquer et accompagner les parents :", link: {url:"https://archiclasse.education.fr/Un-projet-accompagne-est-toujours-un-projet-reussi", text:"Un projet accompagn√© : impliquer parents et usagers (Archiclasse)"}}, texte:`Un parent vient vous voir, persuad√© que la classe flexible ¬´ n'est que du d√©sordre ¬ª. Que lui montrez-vous en priorit√© ?`, qcm:[{text:"Des photos d'√©l√®ves concentr√©s en groupe et en autonomie.", correct:true}, {text:"Votre budget mobilier.", correct:false}, {text:"Des statistiques nationales.", correct:false}], visuel:"https://cdn.pixabay.com/photo/2015/09/18/21/13/classroom-942422_960_720.jpg"},
  {titre:"Limiter les nuisances", xpReward: 100, keyword: {question: "Quel mot-clef dans cet article pour laisser l'√©l√®ve √† BEP se sentir bien dans la classe ? Le professeur lui laisse ... de son espace de travail.", hint: "(2 mots attendus)", answer: "le choix"}, resources: {title: "üìö Ressource √† consulter", intro: "D√©couvrez comment adapter la classe flexible et g√©rer le bruit :", link: {url:"https://www.classe-de-demain.fr/accueil/classe-flexible/comment-adapter-sa-classe-flexible-aux-eleves-aux-besoins-educatifs-particuliers-bep-episode-4", text:"Adapter sa classe flexible et g√©rer le bruit (Classe de Demain)"}}, texte:`Un coll√®gue d'√† c√¥t√© se plaint du bruit. Quelle action prioritaire ?`, qcm:[{text:"Poser des tapis, panneaux acoustiques, et r√©guler les d√©placements.", correct:true}, {text:"Fermer d√©finitivement la salle.", correct:false}, {text:"Accuser l'enseignant flexible.", correct:false}], visuel:"https://images.unsplash.com/photo-1524995997946-a1c2e315a42f"},
  {titre:"√âvoluer dans sa posture", xpReward: 100, keyword: {question: "Comment D√©fine fonctionne pour la r√©partition des √©l√®ves sur diff√©rentes assises ? Par un planning ...", hint: "(1 mot attendu)", answer: "hebdomadaire"}, resources: {title: "üìö Ressource √† consulter", intro: "Explorez le changement de posture de l'enseignant :", link: {url:"https://bloghoptoys.fr/comment-gerer-les-differentes-assises-de-la-classe/", text:"G√©rer les assises et la posture en classe flexible (Blog Hop'Toys)"}}, texte:"Cochez les attitudes professionnelles favorisant la posture de guide :", qcm:[{text:"Encourager l'autonomie et la prise d'initiative", correct:true}, {text:"Laisser les √©l√®ves seuls face √† la t√¢che", correct:false}, {text:"Varier les modalit√©s d'animation", correct:true}, {text:"En variant les propositions d'assises aux √©l√®ves", correct:true}, {text:"Sanctionner ceux qui bougent trop souvent", correct:false}], visuel:"https://cdn.pixabay.com/photo/2018/01/20/08/33/laptop-3095990_960_720.jpg"}
];

function selectMode(mode) {
  const cards = document.querySelectorAll('.mode-card');
  cards.forEach(card => card.classList.remove('selected'));
  event.target.closest('.mode-card').classList.add('selected');
  state.mode = mode;
  localStorage.setItem('classFlexMode', mode);
}

let timerInterval = null;

function startTimer() {
  if(state.timerStarted) return;
  state.timerStarted = true;
  document.getElementById('timerContainer').style.display = 'block';
  timerInterval = setInterval(() => {
    state.timeRemaining--;
    updateTimerDisplay();
    if(state.timeRemaining === 120 && !state.bonusRequested) {
      showBonusModal();
      playWarningSound();
    }
    if(state.timeRemaining <= 0) {
      clearInterval(timerInterval);
      gameOver();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const min = Math.floor(state.timeRemaining / 60);
  const sec = state.timeRemaining % 60;
  const display = document.querySelector('.timer-display');
  if(display) {
    display.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
  }
  const bar = document.querySelector('.timer-bar-fill');
  if(bar) {
    const percent = (state.timeRemaining / 1500) * 100;
    bar.style.width = percent + '%';
  }
  const container = document.getElementById('timerContainer');
  if(container && state.timeRemaining <= 120) {
    container.classList.add('timer-warning');
  }
}

function showBonusModal() {
  state.bonusRequested = true;
  const modal = document.createElement('div');
  modal.className = 'bonus-time-modal';
  modal.innerHTML = `
    <div class="bonus-time-content">
      <div class="icon">‚è∞</div>
      <h2>Temps bonus disponible !</h2>
      <p>Il vous reste seulement 2 minutes. Voulez-vous ajouter 5 minutes suppl√©mentaires ?</p>
      <p style="color: #7F8C8D; font-size: 0.9em;">Attention : accepter r√©duira votre score final de 3 points.</p>
      <div class="buttons">
        <button class="accept-btn" onclick="acceptBonus()">‚úÖ Accepter (+5 min, -3 pts)</button>
        <button class="decline-btn" onclick="declineBonus()">‚ùå Refuser</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function acceptBonus() {
  state.timeRemaining += 300;
  state.score -= 3;
  document.querySelector('.bonus-time-modal').remove();
}

function declineBonus() {
  document.querySelector('.bonus-time-modal').remove();
}

function gameOver() {
  alert("‚è∞ Temps √©coul√© ! Fin de la mission.");
  showEnd();
}

function addXP(amount) {
  state.xp += amount;
  const xpBar = document.getElementById('xpBar');
  if(xpBar) {
    const percent = (state.xp / 600) * 100;
    xpBar.style.width = percent + '%';
  }
  const xpText = document.getElementById('xpText');
  if(xpText) {
    xpText.textContent = state.xp + ' / 600 XP';
  }
}

function updateLetters() {
  const header = document.getElementById('lettersHeader');
  if(!header) return;
  const shuffled = shuffleArray([...state.letters]);
  header.innerHTML = `
    <h3>üî§ Lettres d√©bloqu√©es : ${state.letters.length}/6</h3>
    <div class="letters">
      ${shuffled.map(l => `<span class="letter">${l}</span>`).join('')}
    </div>
  `;
}

function startGame() {
  if(!state.mode) {
    alert("‚ö†Ô∏è Veuillez d'abord s√©lectionner votre mode de jeu !");
    return;
  }
  const app = document.getElementById('app');
  app.innerHTML = `
    <div id="lettersHeader" class="letters-header">
      <h3>üî§ Lettres d√©bloqu√©es : 0/6</h3>
      <div class="letters"></div>
    </div>
    <div id="timerContainer" class="timer-container" style="display:none;">
      <h3>‚è±Ô∏è Temps restant</h3>
      <div class="timer-display">25:00</div>
      <div class="timer-bar">
        <div class="timer-bar-fill"></div>
      </div>
    </div>
    <div id="xpContainer" style="background: var(--lighter); padding: 15px; border-radius: 10px; margin: 20px 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong>üí´ Progression XP</strong>
        <span id="xpText">0 / 600 XP</span>
      </div>
      <div style="width: 100%; height: 15px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;">
        <div id="xpBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--success), var(--accent)); transition: width 0.5s ease;"></div>
      </div>
    </div>
    <div class="notes-section">
      <h3>üìù Bloc-notes de l'√©quipe</h3>
      <p style="font-size: 0.9em; color: #7F8C8D;">Prenez des notes collaboratives tout au long de votre parcours :</p>
      <textarea id="notes" placeholder="Notez ici vos r√©flexions, strat√©gies, points cl√©s d√©couverts..."></textarea>
      <button onclick="downloadNotes()" style="background: var(--secondary); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">üíæ T√©l√©charger mes notes</button>
    </div>
    <div id="game"></div>
  `;
  startTimer();
  showStep();
}

function normalizeText(text){
  return text.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function showCodeMessage(){
  const content = document.getElementById('game');
  content.innerHTML = '';
  const successDiv = document.createElement('div');
  successDiv.className = 'success-message';
  const letter = "SOUPLE"[state.step];
  successDiv.innerHTML = `
    <h3>üéâ Bravo ! Vous avez d√©bloqu√© la lettre "${letter}"</h3>
    <div class="code-display">
      <p><strong>Lettres d√©bloqu√©es :</strong></p>
      <div class="letters">
        ${state.letters.map(l => `<span class="letter">${l}</span>`).join('')}
      </div>
    </div>
  `;
  const continueBtn = document.createElement('button');
  continueBtn.textContent = "Continuer ‚Üí";
  continueBtn.className = 'continue-btn';
  continueBtn.onclick = ()=> {
    state.step++;
    showStep();
  };
  successDiv.appendChild(continueBtn);
  content.appendChild(successDiv);
}

function addBackButton(container){
  if(state.step > 0){
    const backBtn = document.createElement('button');
    backBtn.textContent = "‚Üê Retour";
    backBtn.className = 'back-btn';
    backBtn.onclick = goBack;
    container.insertBefore(backBtn, container.firstChild);
  }
}

function goBack(){
  if(state.step > 0){
    state.step--;
    if(state.letters.length > state.step){
      state.letters.pop();
      state.parcours.pop();
    }
    showStep();
  }
}

function showStep(){
  updateLetters();
  const content = document.getElementById('game');
  if(!content) return;
  content.innerHTML = '';
  if(state.step >= steps.length){
    showEnd();
    return;
  }
  const s = steps[state.step];
  addBackButton(content);
  if(state.mode === 'pilot') {
    showPilotInterface(s, content);
  } else {
    showReaderInterface(s, content);
  }
}

function showPilotInterface(s, container) {
  const hint = pilotHints[state.step];
  const walkieDiv = document.createElement('div');
  walkieDiv.className = 'walkie-alert';
  walkieDiv.innerHTML = `
    <h4><span class="icon">üìª</span> Alerte Talkie-Walkie</h4>
    <p><strong>${hint.alert}</strong></p>
  `;
  container.appendChild(walkieDiv);
  const pilotDiv = document.createElement('div');
  pilotDiv.className = 'pilot-exclusive';
  pilotDiv.innerHTML = `
    <h4>üîí Information exclusive du Pilote</h4>
    <div class="hint-box">
      <p><strong>Mission :</strong></p>
      <p>${hint.hint}</p>
    </div>
    <div class="hint-emphasis">${hint.clue}</div>
    <p><em>üí° Communiquez ces indices √† votre √©quipe via le talkie-walkie pour les aider √† trouver la r√©ponse !</em></p>
  `;
  container.appendChild(pilotDiv);
  const codeDiv = document.createElement('div');
  codeDiv.className = 'pilot-interface';
  codeDiv.innerHTML = `
    <h3>üéØ Validation du code</h3>
    <p>Une fois que votre √©quipe a trouv√© la r√©ponse, entrez la lettre d√©bloqu√©e :</p>
    <div class="code-input-group">
      <input type="text" class="code-input" maxlength="1" id="codeInput">
    </div>
    <button onclick="validatePilotCode()">Valider le code</button>
  `;
  container.appendChild(codeDiv);
  
  // Ajouter la validation par touche Entr√©e
  setTimeout(() => {
    const codeInput = document.getElementById('codeInput');
    if(codeInput) {
      codeInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') {
          validatePilotCode();
        }
      });
      codeInput.focus();
    }
  }, 100);
}

function validatePilotCode() {
  const input = document.getElementById('codeInput');
  const expectedLetter = "SOUPLE"[state.step];
  if(input.value.toUpperCase() === expectedLetter) {
    playSuccessSound();
    validateStep();
  } else {
    playErrorSound();
    alert("‚ùå Code incorrect. V√©rifiez avec votre √©quipe.");
  }
}

function showReaderInterface(s, container) {
  const readerNote = document.createElement('div');
  readerNote.className = 'walkie-alert';
  readerNote.innerHTML = `
    <h4><span class="icon">üìª</span> Mode Lecteur/Chercheur</h4>
    <p><strong>Le Pilote a des informations exclusives !</strong> Restez en contact via le talkie-walkie pour coordonner vos recherches.</p>
  `;
  container.insertBefore(readerNote, container.firstChild);
  showResourcesWithKeyword(s, container);
}

function showResourcesWithKeyword(s, container){
  const titleDiv = document.createElement('div');
  titleDiv.innerHTML = `<h2>${s.titre}</h2>`;
  container.appendChild(titleDiv);
  const resDiv = document.createElement('div');
  resDiv.className = 'resources';
  let html = `<h3>${s.resources.title}</h3>`;
  if(s.resources.intro){
    html += `<p>${s.resources.intro}</p>`;
  }
  html += `<a href="${s.resources.link.url}" target="_blank">${s.resources.link.text}</a>`;
  resDiv.innerHTML = html;
  container.appendChild(resDiv);
  if(s.keyword){
    const keywordDiv = document.createElement('div');
    keywordDiv.className = 'keyword-input';
    keywordDiv.innerHTML = `
      <h4>‚ùì Question de compr√©hension</h4>
      <p><strong>${s.keyword.question}</strong></p>
      <p class="keyword-hint">${s.keyword.hint}</p>
      <input type="text" id="keywordInput" placeholder="Votre r√©ponse...">
      <button id="validateKeyword">Valider la lecture</button>
    `;
    container.appendChild(keywordDiv);
    setTimeout(() => {
      const validateBtn = document.getElementById('validateKeyword');
      const inputField = document.getElementById('keywordInput');
      if(validateBtn && inputField){
        validateBtn.onclick = ()=> {
          const userInput = inputField.value;
          if(normalizeText(userInput) === normalizeText(s.keyword.answer)){
            playSuccessSound();
            if(s.discussion){
              keywordDiv.style.display = 'none';
              const discussionDiv = document.createElement('div');
              discussionDiv.className = 'discussion-box';
              discussionDiv.innerHTML = `<h4>üí¨ Temps d'√©change</h4><p>${s.discussion}</p>`;
              const continueBtn = document.createElement('button');
              continueBtn.textContent = "Continuer vers l'activit√© ‚Üí";
              continueBtn.className = 'continue-btn';
              continueBtn.onclick = ()=> showActivity(s, container);
              discussionDiv.appendChild(continueBtn);
              container.appendChild(discussionDiv);
            } else {
              showActivity(s, container);
            }
          } else {
            playErrorSound();
            alert("R√©ponse incorrecte. Veuillez relire la ressource et r√©essayer.");
          }
        };
        inputField.addEventListener('keypress', (e) => {
          if(e.key === 'Enter'){
            validateBtn.click();
          }
        });
      }
    }, 100);
  }
}

function showActivity(s, container){
  container.innerHTML = '';
  addBackButton(container);
  const activityDiv = document.createElement('div');
  activityDiv.innerHTML = `<h2>${s.titre}</h2><div>${s.texte}</div>${s.visuel?`<img src="${s.visuel}" alt="">`:''}`;
  container.appendChild(activityDiv);
  if(s.qcm){
    const qform = document.createElement('form');
    qform.className = 'qcm';
    s.qcm.forEach((opt, idx)=>{
      const lab=document.createElement('label');
      const cb=document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'qcm'+state.step;
      cb.value=idx;
      lab.appendChild(cb);
      lab.append(' '+opt.text);
      qform.appendChild(lab);
    });
    const valBtn = document.createElement('button');
    valBtn.textContent = "Valider";
    valBtn.type = 'button';
    valBtn.onclick = ()=>validateQCM(s.qcm, qform);
    qform.appendChild(valBtn);
    container.appendChild(qform);
  }
  if(s.dragtask){
    drawDragTask(s.dragtask, container);
  }
}

function validateQCM(qcm, form){
  let allCorrect=true;
  const inputs = Array.from(form.querySelectorAll('input'));
  inputs.forEach((inp,i)=>{
    let isChecked = inp.checked;
    let shouldBeChecked = qcm[i].correct;
    if(isChecked !== shouldBeChecked) allCorrect = false;
  });
  if(allCorrect) {
    playSuccessSound();
    let pointsForStep = 3;
    if(state.step === 2) pointsForStep = 4;
    state.score += pointsForStep;
    form.querySelector('button').disabled = true;
    validateStep();
  } else {
    playErrorSound();
    alert("Essayez encore pour trouver la meilleure r√©ponse !");
  }
}

function drawDragTask(task, container){
  let srcItems=task.items.map(it=>({...it, placed:false}));
  let cats=task.cats.map(c=>({...c, currentItem: null}));
  let dragspace = document.createElement('div');
  dragspace.className = 'dragspace';
  dragspace.id = 'dragSrc';
  dragspace.innerHTML = '<strong>√Ä placer :</strong><br>';
  srcItems.sort(() => Math.random() - 0.5);
  srcItems.forEach(it=>{
    let span= document.createElement('span');
    span.className='draggable';
    span.textContent=it.text;
    span.draggable=true;
    span.dataset.id=it.id;
    span.ondragstart= e=> e.dataTransfer.setData('id', it.id);
    dragspace.appendChild(span);
  });
  container.appendChild(dragspace);
  let stepsGrid = document.createElement('div');
  stepsGrid.className = 'steps-grid';
  cats.forEach(cat=>{
    let dz=document.createElement('div');
    dz.className='dragspace single';
    dz.innerHTML = `<strong>${cat.name}</strong><br>`;
    dz.dataset.cat = cat.key;
    dz.ondragover = e=>e.preventDefault();
    dz.ondrop= e=>{
      e.preventDefault();
      let id = e.dataTransfer.getData('id');
      let item = srcItems.find(o=>o.id==id);
      let elem = document.querySelector('[data-id="'+id+'"]');
      if(item && elem){
        if(cat.currentItem){
          let oldElem = dz.querySelector('.draggable');
          if(oldElem){
            dragspace.appendChild(oldElem);
            cat.currentItem.placed = false;
          }
        }
        cats.forEach(c=>{
          if(c.currentItem && c.currentItem.id === item.id) c.currentItem = null;
        });
        dz.appendChild(elem);
        cat.currentItem = item;
        item.placed = true;
      }
    };
    stepsGrid.appendChild(dz);
  });
  container.appendChild(stepsGrid);
  const btnGroup = document.createElement('div');
  btnGroup.className = 'button-group';
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "üîÑ R√©initialiser";
  resetBtn.className = 'reset-btn';
  resetBtn.onclick = ()=>{
    cats.forEach(c=>{
      if(c.currentItem){
        let elem = document.querySelector('[data-id="'+c.currentItem.id+'"]');
        if(elem) dragspace.appendChild(elem);
        c.currentItem.placed = false;
        c.currentItem = null;
      }
    });
  };
  btnGroup.appendChild(resetBtn);
  const valBtn = document.createElement('button');
  valBtn.textContent = "Valider mon organisation";
  valBtn.onclick = ()=>{
    let filledCount = cats.filter(c=>c.currentItem !== null).length;
    if(filledCount !== 6){
      alert("Veuillez placer exactement 6 √©l√©ments (un par √©tape) avant de valider !");
      return;
    }
    let hasPiege = cats.some(c=>c.currentItem && c.currentItem.cat==='piege');
    let allCorrect = cats.every(c=>c.currentItem && c.currentItem.cat===c.key);
    if(allCorrect && !hasPiege) {
      playSuccessSound();
      state.score += 4;
      valBtn.disabled = true;
      resetBtn.disabled = true;
      validateStep();
    } else {
      playErrorSound();
      if(hasPiege){
        alert("Attention : certaines actions ne sont pas recommand√©es pour d√©marrer une classe flexible. Acheter du mat√©riel sans concertation ou tout changer d'un coup sont des erreurs √† √©viter. R√©essayez !");
      } else {
        alert("Certaines √©tapes ne sont pas dans le bon ordre chronologique. R√©essayez !");
      }
    }
  };
  btnGroup.appendChild(valBtn);
  container.appendChild(btnGroup);
}

function validateStep(){
  const letter="SOUPLE"[state.step];
  state.letters.push(letter);
  state.parcours.push(steps[state.step].titre);
  addXP(steps[state.step].xpReward);
  updateLetters();
  showCodeMessage();
}

function showEnd(){
  clearInterval(timerInterval);
  updateLetters();
  let res = document.getElementById('game');
  if(!res) return;
  let timeBonus = 0;
  if(state.timeRemaining > 0) {
    timeBonus = Math.floor(state.timeRemaining / 60);
  }
  let finalScore = state.score + timeBonus;
  let perf = finalScore >= 18 ? "üèÜ Transformation exemplaire !" : (finalScore>=12? "‚úÖ R√©ussite solide" : "üìà Progr√®s √† faire !");
  
  res.innerHTML = `
    <div class="final-reveal">
      <h2>üéâ F√©licitations !</h2>
      
      <div class="code-word-display">
        <p style="font-size: 1.3em; margin: 0;">Le mot code est :</p>
        <div class="code-word">SOUPLE</div>
        <div class="letters" style="margin-top: 20px;">
          ${'SOUPLE'.split('').map(l => `<span class="letter">${l}</span>`).join('')}
        </div>
      </div>
      
      <div class="reward-box">
        <div class="trophy">üèÜ</div>
        <h3>Vous avez gagn√© !</h3>
        <div class="note-reveal">
          La lettre <strong style="font-size: 1.3em;">E</strong>
        </div>
        <div class="position-badge">
          ü•â 3e position
        </div>
      </div>
      
      <div id="scoring">
        <p>Score d'activit√©s : ${state.score}/20</p>
        <p>Bonus de temps : +${timeBonus} points</p>
        <p><strong>Score final : ${finalScore}/25</strong></p>
        <p><b>${perf}</b></p>
        <p>XP total : ${state.xp} / 600</p>
        <p>Mode jou√© : ${state.mode === 'pilot' ? 'üì± Pilote' : 'üíª Lecteur'}</p>
      </div>
      
      <button id="export" class="continue-btn">üíæ Exporter votre parcours</button>
    </div>
  `;
  
  document.getElementById('export').onclick = function(){
    let id = "CF"+Date.now();
    state.exportID = id;
    let notes = document.getElementById('notes').value;
    let txt = `ID: ${id}\nMode: ${state.mode === 'pilot' ? 'Pilote' : 'Lecteur'}\nScore: ${finalScore}/25\nR√©sultat: ${perf}\nXP: ${state.xp}/600\nParcours: ${state.parcours.join(', ')}\n\n=== NOTES ===\n${notes}`;
    let blob = new Blob([txt], {type:"text/plain"});
    let a = document.createElement('a');
    a.download= 'ClasseFlexible_parcours_'+id+'.txt';
    a.href= URL.createObjectURL(blob);
    a.click();
  };
}

function downloadNotes(){
  let notes = document.getElementById('notes').value;
  if(!notes.trim()){
    alert("Aucune note √† t√©l√©charger !");
    return;
  }
  let blob = new Blob([notes], {type:"text/plain"});
  let a = document.createElement('a');
  a.download= 'MesNotes_ClasseFlexible.txt';
  a.href= URL.createObjectURL(blob);
  a.click();
}
</script>
</body>
</html>
