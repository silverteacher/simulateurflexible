<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulateur D√©cisionnel : Classe Flexible</title>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fa; color: #222; margin:0; padding:0; font-size: 18px;}
.container { max-width: 900px; margin: auto; padding: 20px;}
h1, h2 { color: #266698; font-size: 2em;}
h2 { font-size: 1.6em; }
.progress { margin: 16px 0; font-size: 1.4em; }
.letter-box { display: inline-block; width:50px; height:50px; background:#e3eaf4; margin:8px; text-align:center; line-height:50px; border-radius:8px; font-weight:600; font-size:1.6em; border:1px solid #abbfd3;}
.letter-box.unlocked { background:#acd0e0; color:#222;}
.letter-box.hidden { background:#ccc; color:transparent; user-select: none;}
.qcm, .dragtask { margin-bottom: 26px; font-size: 1.1em;}
.qcm label { display: block; margin: 12px 0; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;}
.qcm label:hover { background: #f0f4f8;}
button, .draggable { background:#266698; color:#fff; border:none; border-radius:6px; padding:12px 18px; margin:12px 0; cursor:pointer; font-size: 1.1em;}
button:disabled { background:#bbb; cursor: not-allowed;}
button:hover:not(:disabled) { background:#1e5178;}
.back-btn { background: #6c757d; float: left;}
.back-btn:hover { background: #5a6268;}
.reset-btn { background: #dc3545; }
.reset-btn:hover:not(:disabled) { background: #c82333;}
img { max-width: 100%; border-radius: 8px; margin:12px 0;}
#export { background: #ffdc82; color: #2e2200; }
#export:hover { background: #ffcf5c;}
#scoring { font-size:1.3em; margin-top:18px;}
.dragspace { background:#ececec; padding:16px; border-radius:8px; min-height:80px; display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; border:2px dashed #266698; font-size: 1.05em;}
.dragspace.single { min-height: 60px; justify-content: center; align-items: center;}
.draggable { background:#547db2; margin: 4px; padding: 10px 14px; font-size: 0.95em; cursor: move;}
.draggable:hover { background:#3d5d8f;}
.resources { background: #e8f4f8; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #266698;}
.resources h3 { color: #266698; margin-top:0; font-size: 1.3em;}
.resources a { color: #1e5178; text-decoration: none; font-weight: 500; display: block; margin: 12px 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #abbfd3;}
.resources a:hover { text-decoration: underline; background: #f0f4f8;}
.keyword-input { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #266698;}
.keyword-input h4 { color: #266698; margin-top: 0;}
.keyword-input input { width: 100%; padding: 12px; border: 2px solid #abbfd3; border-radius: 6px; font-size: 1em; margin: 10px 0; box-sizing: border-box;}
.keyword-hint { color: #666; font-style: italic; margin: 10px 0; font-size: 0.95em;}
.discussion-box { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;}
.discussion-box h4 { color: #856404; margin-top: 0;}
.notes-area { margin: 20px 0; }
.notes-area textarea { width: 100%; min-height: 150px; padding: 12px; border: 2px solid #abbfd3; border-radius: 8px; font-size: 1em; font-family: inherit; resize: vertical; box-sizing: border-box;}
.video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 20px 0; border-radius: 8px;}
.video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%;}
.continue-btn { background: #28a745; margin-top: 20px;}
.continue-btn:hover { background: #218838;}
.button-group { margin-top: 20px; overflow: auto;}
.steps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0;}
.success-message { background: #d4edda; color: #155724; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #28a745; text-align: center;}
.success-message h3 { margin-top: 0; font-size: 1.5em;}
.code-display { background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #28a745;}
.code-display .letters { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
.code-display .letter { display: inline-block; width: 60px; height: 60px; background: #acd0e0; border-radius: 8px; text-align: center; line-height: 60px; font-size: 2em; font-weight: bold; border: 2px solid #266698;}
.qr-container { text-align: center; margin: 30px 0;}
.qr-container img { max-width: 300px; border: 3px solid #266698; border-radius: 12px; padding: 10px; background: white;}

@media (max-width: 768px) {
  body { font-size: 16px; }
  .container { padding: 15px; }
  h1 { font-size: 1.6em; }
  h2 { font-size: 1.3em; }
  .letter-box { width: 40px; height: 40px; line-height: 40px; font-size: 1.3em; margin: 5px;}
  .dragspace { padding: 12px; min-height: 60px; }
  button, .draggable { padding: 10px 14px; font-size: 1em; }
  .steps-grid { grid-template-columns: 1fr;}
  .code-display .letter { width: 45px; height: 45px; line-height: 45px; font-size: 1.5em;}
}

@media (max-width: 480px) {
  body { font-size: 15px; }
  h1 { font-size: 1.4em; }
  .letter-box { width: 35px; height: 35px; line-height: 35px; font-size: 1.1em; margin: 3px;}
  .code-display .letter { width: 40px; height: 40px; line-height: 40px; font-size: 1.3em;}
}
</style>
</head>
<body>
<div class="container">
<h1>Simulateur D√©cisionnel : Classe Flexible</h1>
<div class="progress" id="progress">Lettres d√©bloqu√©es :</div>
<div id="letters"></div>
<div id="game"></div>
<div class="notes-area">
  <h3 style="color:#266698;">üìù Espace de prise de notes</h3>
  <textarea id="notes" placeholder="Notez ici vos r√©flexions, id√©es et observations..."></textarea>
  <button onclick="downloadNotes()" style="background:#547db2;">üíæ T√©l√©charger mes notes</button>
</div>
<div id="scoring"></div>
<div id="exportArea"></div>
</div>

<script>
let state = {step: 0, score:0, letters: [], parcours:[], exportID: ""};
const steps = [
  {
    titre:"S ‚Äì Sensibiliser l'√©quipe",
    keyword: {
      question: "Qu'est-ce qu'un am√©nagement de classe flexible peut tendre √† r√©duire chez les √©l√®ves ?",
      hint: "(2 mots attendus)",
      answer: "le stress"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Avant de r√©pondre, consultez cette ressource sur l'importance de l'am√©nagement de classe :",
      link: {url:"https://www.reseau-canope.fr/actualites/article/amenager-sa-classe-pour-servir-sa-pedagogie", text:"Am√©nager sa classe pour servir sa p√©dagogie (R√©seau Canop√©)"}
    },
    texte:"Un enseignant refuse de bouger les tables de sa classe et remet en cause l'int√©r√™t de la flexibilit√©. Quel argument est le plus efficace pour engager le dialogue ?",
    qcm: [
      {text:"¬´ La classe flexible est grav√©e dans le marbre, c'est un projet sp√©cifique. ¬ª", correct:false},
      {text:"¬´ La flexibilit√© favorise la collaboration et l'engagement des √©l√®ves. ¬ª", correct:true},
      {text:"¬´ On doit suivre la tendance, c'est le XXIe si√®cle ! ¬ª", correct:false},
    ],
    visuel:"https://cdn.pixabay.com/photo/2017/01/10/19/05/classroom-1963759_960_720.jpg"
  },
  {
    titre:"O ‚Äì Organiser le projet",
    keyword: {
      question: "Dans le premier degr√©, quel outil pour planifier les t√¢ches des √©l√®ves peut √™tre utile dans le second degr√© aussi ?",
      hint: "(4 mots attendus)",
      answer: "le plan de travail"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Consultez cette ressource pour comprendre les √©tapes d'un projet de classe flexible :",
      link: {url:"https://bloghoptoys.fr/comment-reussir-votre-projet-de-classe-flexible/", text:"Comment r√©ussir votre projet de classe flexible ? (Blog Hop'Toys)"}
    },
    texte:"Organisez les √©tapes de d√©marrage d'une classe flexible dans l'ordre chronologique. Glissez chaque √©l√©ment dans la bonne position (une seule carte par √©tape).",
    dragtask: {
      items: [
         {id:"1", text:"R√©fl√©chir au projet et d√©finir les objectifs p√©dagogiques", cat:"etape1"},
         {id:"2", text:"Former l'√©quipe et mobiliser les enseignants", cat:"etape2"},
         {id:"3", text:"R√©cup√©rer ou acheter du mat√©riel au fur et √† mesure", cat:"etape3"},
         {id:"4", text:"Am√©nager la classe avec diff√©rentes zones", cat:"etape4"},
         {id:"5", text:"√âtablir des r√®gles claires avec les √©l√®ves", cat:"etape5"},
         {id:"6", text:"Observer et ajuster progressivement", cat:"etape6"},
         {id:"7", text:"Acheter du mat√©riel sans concertation", cat:"piege"},
         {id:"8", text:"Tout changer d'un coup sans test", cat:"piege"},
      ],
      cats: [
        {name: "√âtape 1", key:"etape1"},
        {name: "√âtape 2", key:"etape2"},
        {name: "√âtape 3", key:"etape3"},
        {name: "√âtape 4", key:"etape4"},
        {name: "√âtape 5", key:"etape5"},
        {name: "√âtape 6", key:"etape6"}
      ]
    },
    visuel:"https://images.unsplash.com/photo-1523580846011-d3a5bc25702b"
  },
  {
    titre:"U ‚Äì Utilit√© p√©dagogique",
    keyword: {
      question: "Quel est le conseil d'Am√©lie, l'enseignante de lettres pour se lancer : doit-on tout changer dans sa p√©dagogie ?",
      hint: "(r√©ponse : oui ou non)",
      answer: "non"
    },
    discussion: "üí¨ Apr√®s avoir visionn√© cette vid√©o, discutez des points qui vous ont marqu√©s.",
    resources: {
      title: "üìö Ressource √† consulter (vid√©o)",
      intro: "D√©couvrez les b√©n√©fices p√©dagogiques de la classe flexible :",
      link: {url:"https://canotech.fr/a/la-classe-flexible-pour-faire-classe-a-tous-les-eleves", text:"La classe flexible pour faire classe √† tous les √©l√®ves (CanoTech)"}
    },
    texte:"Cochez les avantages p√©dagogiques document√©s de la classe flexible :",
    qcm: [
      {text:"Plus grande motivation des √©l√®ves", correct:true},
      {text:"Meilleur climat de classe", correct:true},
      {text:"Automaticit√© des r√©sultats √©lev√©s", correct:false},
      {text:"Favorise l'autonomie", correct:true},
      {text:"Les √©l√®ves ne font plus de bruit", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2017/09/09/21/13/class-2732253_960_720.jpg"
  },
  {
    titre:"P ‚Äì Parent inquiet",
    keyword: {
      question: "Dans l'article d'Archiclasse, dans la partie t√©moignage d'Anne-C√©cile Call√©jon, quel sport est utilis√© pour cr√©er la m√©taphore du travail d'√©quipe ?",
      hint: "(2 mots attendus)",
      answer: "le curling"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "D√©couvrez comment impliquer et accompagner les parents :",
      link: {url:"https://archiclasse.education.fr/Un-projet-accompagne-est-toujours-un-projet-reussi", text:"Un projet accompagn√© : impliquer parents et usagers (Archiclasse)"}
    },
    texte:`Un parent vient vous voir, persuad√© que la classe flexible ¬´ n'est que du d√©sordre ¬ª. Que lui montrez-vous en priorit√© ?`,
    qcm:[
      {text:"Des photos d'√©l√®ves concentr√©s en groupe et en autonomie.", correct:true},
      {text:"Votre budget mobilier.", correct:false},
      {text:"Des statistiques nationales.", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2015/09/18/21/13/classroom-942422_960_720.jpg"
  },
  {
    titre:"L ‚Äì Limiter les nuisances",
    keyword: {
      question: "Quel mot-clef dans cet article pour laisser l'√©l√®ve √† BEP se sentir bien dans la classe ? Le professeur lui laisse ... de son espace de travail.",
      hint: "(2 mots attendus)",
      answer: "le choix"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "D√©couvrez comment adapter la classe flexible et g√©rer le bruit :",
      link: {url:"https://www.classe-de-demain.fr/accueil/classe-flexible/comment-adapter-sa-classe-flexible-aux-eleves-aux-besoins-educatifs-particuliers-bep-episode-4", text:"Adapter sa classe flexible et g√©rer le bruit (Classe de Demain)"}
    },
    texte:`Un coll√®gue d'√† c√¥t√© se plaint du bruit. Quelle action prioritaire ?`,
    qcm:[
      {text:"Poser des tapis, panneaux acoustiques, et r√©guler les d√©placements.", correct:true},
      {text:"Fermer d√©finitivement la salle.", correct:false},
      {text:"Accuser l'enseignant flexible.", correct:false}
    ],
    visuel:"https://images.unsplash.com/photo-1524995997946-a1c2e315a42f"
  },
  {
    titre:"E ‚Äì √âvoluer dans sa posture",
    keyword: {
      question: "Comment D√©fine fonctionne pour la r√©partition des √©l√®ves sur diff√©rentes assises ? Par un planning ...",
      hint: "(1 mot attendu)",
      answer: "hebdomadaire"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Explorez le changement de posture de l'enseignant :",
      link: {url:"https://bloghoptoys.fr/comment-gerer-les-differentes-assises-de-la-classe/", text:"G√©rer les assises et la posture en classe flexible (Blog Hop'Toys)"}
    },
    texte:"Cochez les attitudes professionnelles favorisant la posture de guide :",
    qcm:[
      {text:"Encourager l'autonomie et la prise d'initiative", correct:true},
      {text:"Laisser les √©l√®ves seuls face √† la t√¢che", correct:false},
      {text:"Varier les modalit√©s d'animation", correct:true},
      {text:"En variant les propositions d'assises aux √©l√®ves", correct:true},
      {text:"Sanctionner ceux qui bougent trop souvent", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2018/01/20/08/33/laptop-3095990_960_720.jpg"
  }
];

function normalizeText(text){
  return text.toLowerCase().trim().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
}

function updateLetters(){
  const container = document.getElementById('letters');
  if(!container) return;
  container.innerHTML = '';
  'SOUPLE'.split('').forEach((l,i)=> {
    const box = document.createElement('span');
    const isUnlocked = state.letters.includes(l);
    box.className = 'letter-box'+(isUnlocked?' unlocked':' hidden');
    box.textContent = isUnlocked ? l : '?';
    container.appendChild(box);
  });
}

function showCodeMessage(){
  const content = document.getElementById('game');
  content.innerHTML = '';
  
  const successDiv = document.createElement('div');
  successDiv.className = 'success-message';
  
  const letter = "SOUPLE"[state.step];
  successDiv.innerHTML = `
    <h3>üéâ Bravo ! Vous avez d√©bloqu√© la lettre "${letter}"</h3>
    <div class="code-display">
      <p><strong>Code actuel :</strong></p>
      <div class="letters">
        ${state.letters.map(l => `<span class="letter">${l}</span>`).join('')}
      </div>
    </div>
  `;
  
  const continueBtn = document.createElement('button');
  continueBtn.textContent = "Continuer ‚Üí";
  continueBtn.className = 'continue-btn';
  continueBtn.onclick = ()=> {
    state.step++;
    showStep();
  };
  
  successDiv.appendChild(continueBtn);
  content.appendChild(successDiv);
}

function addBackButton(container){
  if(state.step > 0){
    const backBtn = document.createElement('button');
    backBtn.textContent = "‚Üê Retour";
    backBtn.className = 'back-btn';
    backBtn.onclick = goBack;
    container.insertBefore(backBtn, container.firstChild);
  }
}

function goBack(){
  if(state.step > 0){
    state.step--;
    if(state.letters.length > state.step){
      state.letters.pop();
      state.parcours.pop();
    }
    showStep();
  }
}

function showStep(){
  updateLetters();
  const content = document.getElementById('game');
  if(!content) return;
  content.innerHTML = '';
  
  if(state.step >= steps.length){
    showEnd();
    return;
  }
  
  const s = steps[state.step];
  addBackButton(content);
  showResourcesWithKeyword(s, content);
}

function showResourcesWithKeyword(s, container){
  const titleDiv = document.createElement('div');
  titleDiv.innerHTML = `<h2>${s.titre}</h2>`;
  container.appendChild(titleDiv);
  
  const resDiv = document.createElement('div');
  resDiv.className = 'resources';
  let html = `<h3>${s.resources.title}</h3>`;
  if(s.resources.intro){
    html += `<p>${s.resources.intro}</p>`;
  }
  html += `<a href="${s.resources.link.url}" target="_blank">üìö ${s.resources.link.text}</a>`;
  resDiv.innerHTML = html;
  container.appendChild(resDiv);
  
  if(s.keyword){
    const keywordDiv = document.createElement('div');
    keywordDiv.className = 'keyword-input';
    keywordDiv.innerHTML = `
      <h4>Question de compr√©hension :</h4>
      <p><strong>${s.keyword.question}</strong></p>
      <p class="keyword-hint">${s.keyword.hint}</p>
      <input type="text" id="keywordInput" placeholder="Votre r√©ponse...">
      <button id="validateKeyword">‚úÖ Valider la lecture</button>
    `;
    container.appendChild(keywordDiv);
    
    setTimeout(() => {
      const validateBtn = document.getElementById('validateKeyword');
      const inputField = document.getElementById('keywordInput');
      
      if(validateBtn && inputField){
        validateBtn.onclick = ()=> {
          const userInput = inputField.value;
          if(normalizeText(userInput) === normalizeText(s.keyword.answer)){
            if(s.discussion){
              keywordDiv.style.display = 'none';
              const discussionDiv = document.createElement('div');
              discussionDiv.className = 'discussion-box';
              discussionDiv.innerHTML = `<h4>üí¨ Temps d'√©change</h4><p>${s.discussion}</p>`;
              const continueBtn = document.createElement('button');
              continueBtn.textContent = "Continuer vers l'activit√© ‚Üí";
              continueBtn.className = 'continue-btn';
              continueBtn.onclick = ()=> showActivity(s, container);
              discussionDiv.appendChild(continueBtn);
              container.appendChild(discussionDiv);
            } else {
              showActivity(s, container);
            }
          } else {
            alert("R√©ponse incorrecte. Veuillez relire la ressource et r√©essayer.");
          }
        };
        
        inputField.addEventListener('keypress', (e) => {
          if(e.key === 'Enter'){
            validateBtn.click();
          }
        });
      }
    }, 100);
  }
}

function showActivity(s, container){
  container.innerHTML = '';
  addBackButton(container);
  
  const activityDiv = document.createElement('div');
  activityDiv.innerHTML = `<h2>${s.titre}</h2><div>${s.texte}</div>${s.visuel?`<img src="${s.visuel}" alt="">`:''}`;
  container.appendChild(activityDiv);
  
  if(s.qcm){
    const qform = document.createElement('form');
    qform.className = 'qcm';
    s.qcm.forEach((opt, idx)=>{
      const lab=document.createElement('label');
      const cb=document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'qcm'+state.step;
      cb.value=idx;
      lab.appendChild(cb);
      lab.append(' '+opt.text);
      qform.appendChild(lab);
    });
    const valBtn = document.createElement('button');
    valBtn.textContent = "Valider";
    valBtn.type = 'button';
    valBtn.onclick = ()=>validateQCM(s.qcm, qform);
    qform.appendChild(valBtn);
    container.appendChild(qform);
  }
  
  if(s.dragtask){
    drawDragTask(s.dragtask, container);
  }
}

function validateQCM(qcm, form){
  let allCorrect=true;
  const inputs = Array.from(form.querySelectorAll('input'));
  
  inputs.forEach((inp,i)=>{
    let isChecked = inp.checked;
    let shouldBeChecked = qcm[i].correct;
    if(isChecked !== shouldBeChecked) allCorrect = false;
  });
  
  if(allCorrect) {
    let correctCount = qcm.filter(q=>q.correct).length;
    state.score += correctCount;
    form.querySelector('button').disabled = true;
    validateStep();
  } else {
    alert("Essayez encore pour trouver la meilleure r√©ponse !");
  }
}

function drawDragTask(task, container){
  let srcItems=task.items.map(it=>({...it, placed:false}));
  let cats=task.cats.map(c=>({...c, currentItem: null}));
  
  let dragspace = document.createElement('div');
  dragspace.className = 'dragspace';
  dragspace.id = 'dragSrc';
  dragspace.innerHTML = '<strong>√Ä placer :</strong><br>';
  
  srcItems.sort(() => Math.random() - 0.5);
  
  srcItems.forEach(it=>{
    let span= document.createElement('span');
    span.className='draggable';
    span.textContent=it.text;
    span.draggable=true;
    span.dataset.id=it.id;
    span.ondragstart= e=> e.dataTransfer.setData('id', it.id);
    dragspace.appendChild(span);
  });
  container.appendChild(dragspace);

  let stepsGrid = document.createElement('div');
  stepsGrid.className = 'steps-grid';
  
  cats.forEach(cat=>{
    let dz=document.createElement('div');
    dz.className='dragspace single';
    dz.innerHTML = `<strong>${cat.name}</strong><br>`;
    dz.dataset.cat = cat.key;
    
    dz.ondragover = e=>e.preventDefault();
    dz.ondrop= e=>{
      e.preventDefault();
      let id = e.dataTransfer.getData('id');
      let item = srcItems.find(o=>o.id==id);
      let elem = document.querySelector('[data-id="'+id+'"]');
      
      if(item && elem){
        if(cat.currentItem){
          let oldElem = dz.querySelector('.draggable');
          if(oldElem){
            dragspace.appendChild(oldElem);
            cat.currentItem.placed = false;
          }
        }
        
        cats.forEach(c=>{
          if(c.currentItem && c.currentItem.id === item.id) c.currentItem = null;
        });
        
        dz.appendChild(elem);
        cat.currentItem = item;
        item.placed = true;
      }
    };
    stepsGrid.appendChild(dz);
  });
  container.appendChild(stepsGrid);
  
  const btnGroup = document.createElement('div');
  btnGroup.className = 'button-group';
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "üîÑ R√©initialiser";
  resetBtn.className = 'reset-btn';
  resetBtn.onclick = ()=>{
    cats.forEach(c=>{
      if(c.currentItem){
        let elem = document.querySelector('[data-id="'+c.currentItem.id+'"]');
        if(elem) dragspace.appendChild(elem);
        c.currentItem.placed = false;
        c.currentItem = null;
      }
    });
  };
  btnGroup.appendChild(resetBtn);
  
  const valBtn = document.createElement('button');
  valBtn.textContent = "Valider mon organisation";
  valBtn.onclick = ()=>{
    let filledCount = cats.filter(c=>c.currentItem !== null).length;
    if(filledCount !== 6){
      alert("Veuillez placer exactement 6 √©l√©ments (un par √©tape) avant de valider !");
      return;
    }
    
    let hasPiege = cats.some(c=>c.currentItem && c.currentItem.cat==='piege');
    let allCorrect = cats.every(c=>c.currentItem && c.currentItem.cat===c.key);
    
    if(allCorrect && !hasPiege) {
      state.score += 2;
      valBtn.disabled = true;
      resetBtn.disabled = true;
      validateStep();
    } else {
      if(hasPiege){
        alert("Attention : certaines actions ne sont pas recommand√©es pour d√©marrer une classe flexible. Acheter du mat√©riel sans concertation ou tout changer d'un coup sont des erreurs √† √©viter. R√©essayez !");
      } else {
        alert("Certaines √©tapes ne sont pas dans le bon ordre chronologique. R√©essayez !");
      }
    }
  };
  btnGroup.appendChild(valBtn);
  container.appendChild(btnGroup);
}

function validateStep(){
  const letter="SOUPLE"[state.step];
  state.letters.push(letter);
  state.parcours.push(steps[state.step].titre);
  updateLetters();
  showCodeMessage();
}

function showEnd(){
  updateLetters();
  let res = document.getElementById('game');
  if(!res) return;
  let perf = state.score >= 12 ? "Transformation exemplaire !" : (state.score>=9? "R√©ussite solide" : "Progr√®s √† faire !");
  res.innerHTML = `<h2>üéâ F√©licitations, vous avez d√©bloqu√© toutes les lettres !</h2>
    <div class="code-display">
      <p><strong>Code final : SOUPLE</strong></p>
      <div class="letters">
        ${'SOUPLE'.split('').map(l => `<span class="letter">${l}</span>`).join('')}
      </div>
    </div>
    <div id="scoring">Votre score : ${state.score}/16 <br><b>${perf}</b></div>
    <div class="qr-container">
      <h3>üéÅ D√©couvrez votre r√©compense !</h3>
      <p>Scannez ce QR code pour acc√©der √† votre bonus :</p>
      <img src="https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/qr.png" alt="QR Code R√©compense">
    </div>
    <button id="export">üì• Exporter votre parcours</button>`;
  
  document.getElementById('export').onclick = function(){
    let id = "CF"+Date.now();
    state.exportID = id;
    let notes = document.getElementById('notes').value;
    let txt = `ID: ${id}\nScore: ${state.score}/16\nR√©sultat: ${perf}\nParcours: ${state.parcours.join(', ')}\n\n=== NOTES ===\n${notes}`;
    let blob = new Blob([txt], {type:"text/plain"});
    let a = document.createElement('a');
    a.download= 'ClasseFlexible_parcours_'+id+'.txt';
    a.href= URL.createObjectURL(blob);
    a.click();
  };
}

function downloadNotes(){
  let notes = document.getElementById('notes').value;
  if(!notes.trim()){
    alert("Aucune note √† t√©l√©charger !");
    return;
  }
  let blob = new Blob([notes], {type:"text/plain"});
  let a = document.createElement('a');
  a.download= 'MesNotes_ClasseFlexible.txt';
  a.href= URL.createObjectURL(blob);
  a.click();
}

window.addEventListener('DOMContentLoaded', function(){
  updateLetters();
  showStep();
});
</script>
</body>
</html>
