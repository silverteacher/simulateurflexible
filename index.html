<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulateur Classe Flexible - Les Experts Flexibles</title>
<style>
:root {
  --primary: #2C3E50;
  --secondary: #3498DB;
  --accent: #1ABC9C;
  --success: #27AE60;
  --warning: #F39C12;
  --danger: #E74C3C;
  --light: #ECF0F1;
  --dark: #34495E;
  --bg: #F8F9FA;
  --text: #2C3E50;
}

* { box-sizing: border-box; }

body { 
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: var(--text); 
  margin:0; 
  padding:20px; 
  font-size: 16px;
  line-height: 1.6;
  min-height: 100vh;
}

.container { 
  max-width: 900px; 
  margin: auto; 
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

/* === INTRO SCREEN === */
.intro-screen {
  text-align: center;
  padding: 40px 20px;
}

.intro-screen h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  background: linear-gradient(135deg, var(--secondary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.intro-screen .welcome-text {
  background: linear-gradient(135deg, #E8F8F5, #D5F4E6);
  padding: 30px;
  border-radius: 15px;
  margin: 30px 0;
  border-left: 5px solid var(--accent);
  text-align: left;
  line-height: 1.9;
  font-size: 1.1em;
}

.intro-screen .start-btn {
  background: linear-gradient(135deg, var(--success), #229954);
  color: white;
  border: none;
  padding: 20px 50px;
  font-size: 1.4em;
  font-weight: 700;
  border-radius: 15px;
  cursor: pointer;
  margin-top: 30px;
  box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
  transition: all 0.3s ease;
}

.intro-screen .start-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(39, 174, 96, 0.5);
}

.mode-selector {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin: 30px 0;
  flex-wrap: wrap;
}

.mode-card {
  background: white;
  border: 3px solid var(--secondary);
  border-radius: 15px;
  padding: 25px;
  width: 250px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.mode-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
  border-color: var(--accent);
}

.mode-card.selected {
  background: linear-gradient(135deg, var(--secondary), #2980B9);
  color: white;
  border-color: var(--accent);
}

.mode-card h3 {
  margin-top: 0;
  font-size: 1.4em;
}

.mode-card .icon {
  font-size: 3em;
  margin-bottom: 15px;
}

/* === TIMER === */
.timer-container {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 20px;
  border-radius: 15px;
  margin: 20px 0;
  text-align: center;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.timer-display {
  font-size: 3em;
  font-weight: 700;
  margin: 15px 0;
  font-family: 'Courier New', monospace;
}

.timer-bar {
  width: 100%;
  height: 20px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 15px;
}

.timer-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
  transition: width 1s linear;
}

.timer-warning {
  background: linear-gradient(135deg, var(--warning), #D68910);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.bonus-time-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.bonus-time-content {
  background: white;
  padding: 40px;
  border-radius: 20px;
  max-width: 500px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.bonus-time-content h2 {
  color: var(--warning);
  margin-top: 0;
  font-size: 2em;
}

.bonus-time-content button {
  margin: 10px;
  padding: 15px 30px;
  font-size: 1.1em;
}

/* === XP & BADGES === */
.xp-bar-container {
  background: var(--light);
  border-radius: 15px;
  padding: 20px;
  margin: 20px 0;
}

.xp-bar {
  width: 100%;
  height: 30px;
  background: #BDC3C7;
  border-radius: 15px;
  overflow: hidden;
  position: relative;
}

.xp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--secondary));
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
}

.badges-container {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  margin: 20px 0;
}

.badge {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2em;
  background: linear-gradient(135deg, #BDC3C7, #95A5A6);
  border: 3px solid #7F8C8D;
  transition: all 0.3s ease;
  position: relative;
}

.badge.unlocked {
  background: linear-gradient(135deg, var(--warning), #D68910);
  border-color: var(--success);
  animation: badgeUnlock 0.5s ease;
}

@keyframes badgeUnlock {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.badge-tooltip {
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--dark);
  color: white;
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 0.6em;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
}

.badge:hover .badge-tooltip {
  opacity: 1;
}

/* === PILOT MODE === */
.pilot-interface {
  background: linear-gradient(135deg, #FFF9E6, #FFF3CD);
  padding: 30px;
  border-radius: 15px;
  margin: 20px 0;
  border: 3px solid var(--warning);
}

.pilot-interface h3 {
  color: var(--warning);
  margin-top: 0;
}

.code-input-group {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  justify-content: center;
}

.code-input {
  width: 60px;
  height: 60px;
  font-size: 2em;
  text-align: center;
  border: 3px solid var(--secondary);
  border-radius: 10px;
  font-weight: 700;
  text-transform: uppercase;
}

.code-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
}

/* === EXISTING STYLES === */
h1 { 
  color: var(--primary); 
  font-size: 2.2em;
  font-weight: 700;
  text-align: center;
  margin-bottom: 10px;
}

h2 { 
  color: var(--primary); 
  font-size: 1.8em;
  font-weight: 600;
  margin-top: 30px;
  border-left: 4px solid var(--accent);
  padding-left: 15px;
}

h3 {
  color: var(--dark);
  font-size: 1.3em;
  font-weight: 600;
}

.progress { 
  margin: 20px 0; 
  font-size: 1.1em;
  text-align: center;
  color: var(--dark);
  font-weight: 500;
}

.letter-box { 
  display: inline-block; 
  width:50px; 
  height:50px; 
  background: linear-gradient(135deg, #E8EAF6, #C5CAE9);
  margin:6px; 
  text-align:center; 
  line-height:50px; 
  border-radius:12px; 
  font-weight:700; 
  font-size:1.5em; 
  border:2px solid #9FA8DA;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.letter-box.unlocked { 
  background: linear-gradient(135deg, var(--accent), #16A085);
  color:#fff;
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(26, 188, 156, 0.4);
}

.letter-box.hidden { 
  background: #BDC3C7;
  color:transparent;
  user-select: none;
}

.qcm { 
  margin: 20px 0; 
  font-size: 1.05em;
}

.qcm label { 
  display: block; 
  margin: 12px 0; 
  cursor: pointer; 
  padding: 15px 20px; 
  border-radius: 10px; 
  transition: all 0.3s ease;
  background: var(--light);
  border: 2px solid transparent;
}

.qcm label:hover { 
  background: #E8F8F5;
  border-color: var(--accent);
  transform: translateX(5px);
}

button { 
  background: linear-gradient(135deg, var(--secondary), #2980B9);
  color:#fff; 
  border:none; 
  border-radius:10px; 
  padding:14px 28px; 
  margin:12px 8px 12px 0; 
  cursor:pointer; 
  font-size: 1.05em;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

button:disabled { 
  background: linear-gradient(135deg, #95A5A6, #7F8C8D);
  cursor: not-allowed;
  box-shadow: none;
}

button:hover:not(:disabled) { 
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
}

.back-btn { 
  background: linear-gradient(135deg, #95A5A6, #7F8C8D);
  float: left;
}

.back-btn:hover { 
  background: linear-gradient(135deg, #7F8C8D, #6C7A89);
}

.reset-btn { 
  background: linear-gradient(135deg, var(--danger), #C0392B);
}

.reset-btn:hover:not(:disabled) { 
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

img { 
  max-width: 100%; 
  max-height: 280px;
  object-fit: cover;
  border-radius: 12px; 
  margin:15px 0;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

#export { 
  background: linear-gradient(135deg, var(--warning), #D68910);
}

#export:hover { 
  box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
}

#scoring { 
  font-size:1.3em; 
  margin-top:20px;
  text-align: center;
  color: var(--primary);
  font-weight: 600;
}

.dragspace { 
  background: linear-gradient(135deg, #F8F9FA, #E9ECEF);
  padding:20px; 
  border-radius:12px; 
  min-height:80px; 
  display:flex; 
  gap:12px; 
  flex-wrap:wrap; 
  margin:15px 0; 
  border:3px dashed var(--secondary);
  transition: all 0.3s ease;
}

.dragspace:hover {
  border-color: var(--accent);
  background: #F0F8FF;
}

.dragspace.single { 
  min-height: 70px; 
  justify-content: center; 
  align-items: center;
}

.draggable { 
  background: linear-gradient(135deg, var(--secondary), #2980B9);
  margin: 4px; 
  padding: 12px 18px; 
  font-size: 0.95em; 
  cursor: move;
  color: white;
  border-radius: 8px;
  font-weight: 500;
  box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
  transition: all 0.2s ease;
}

.draggable:hover { 
  background: linear-gradient(135deg, #2980B9, #1F618D);
  transform: scale(1.05);
}

.resources { 
  background: linear-gradient(135deg, #E8F8F5, #D5F4E6);
  padding: 25px; 
  border-radius: 12px; 
  margin: 25px 0; 
  border-left: 5px solid var(--accent);
  box-shadow: 0 4px 15px rgba(26, 188, 156, 0.1);
}

.resources h3 { 
  color: var(--accent); 
  margin-top:0; 
  font-size: 1.3em;
  font-weight: 700;
}

.resources a { 
  color: var(--secondary); 
  text-decoration: none; 
  font-weight: 600; 
  display: block; 
  margin: 15px 0; 
  padding: 15px 20px; 
  background: white; 
  border-radius: 10px; 
  border: 2px solid var(--accent);
  transition: all 0.3s ease;
}

.resources a:hover { 
  background: var(--accent);
  color: white;
  transform: translateX(5px);
}

.keyword-input { 
  background: white; 
  padding: 25px; 
  border-radius: 12px; 
  margin: 25px 0; 
  border: 3px solid var(--secondary);
  box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
}

.keyword-input h4 { 
  color: var(--secondary); 
  margin-top: 0;
  font-size: 1.2em;
  font-weight: 600;
}

.keyword-input input { 
  width: 100%; 
  padding: 14px 18px; 
  border: 2px solid #BDC3C7; 
  border-radius: 10px; 
  font-size: 1em; 
  margin: 12px 0;
  transition: all 0.3s ease;
}

.keyword-input input:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.keyword-hint { 
  color: #7F8C8D; 
  font-style: italic; 
  margin: 8px 0; 
  font-size: 0.95em;
}

.discussion-box { 
  background: linear-gradient(135deg, #FFF9E6, #FFF3CD);
  padding: 25px; 
  border-radius: 12px; 
  margin: 25px 0; 
  border-left: 5px solid var(--warning);
  box-shadow: 0 4px 15px rgba(243, 156, 18, 0.1);
}

.discussion-box h4 { 
  color: #D68910; 
  margin-top: 0;
  font-weight: 700;
  font-size: 1.2em;
}

.discussion-box p {
  line-height: 1.8;
  color: var(--dark);
}

.notes-area { 
  margin: 30px 0; 
  padding: 25px;
  background: linear-gradient(135deg, #F8F9FA, #ECF0F1);
  border-radius: 12px;
}

.notes-area h3 {
  margin-top: 0;
}

.notes-area textarea { 
  width: 100%; 
  min-height: 150px; 
  padding: 15px; 
  border: 2px solid #BDC3C7; 
  border-radius: 10px; 
  font-size: 1em; 
  font-family: inherit; 
  resize: vertical;
  transition: all 0.3s ease;
}

.notes-area textarea:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.continue-btn { 
  background: linear-gradient(135deg, var(--success), #229954);
  margin-top: 20px;
}

.continue-btn:hover { 
  box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
}

.button-group { 
  margin-top: 20px; 
  overflow: auto;
}

.steps-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
  gap: 15px; 
  margin: 20px 0;
}

.success-message { 
  background: linear-gradient(135deg, #D5F4E6, #ABEBC6);
  color: #186A3B; 
  padding: 30px; 
  border-radius: 15px; 
  margin: 25px 0; 
  border-left: 5px solid var(--success); 
  text-align: center;
  box-shadow: 0 8px 25px rgba(39, 174, 96, 0.2);
}

.success-message h3 { 
  margin-top: 0; 
  font-size: 1.6em;
  color: var(--success);
}

.code-display { 
  background: white; 
  padding: 20px; 
  border-radius: 12px; 
  margin: 20px 0; 
  border: 3px solid var(--success);
  box-shadow: 0 4px 15px rgba(39, 174, 96, 0.1);
}

.code-display .letters { 
  display: flex; 
  justify-content: center; 
  gap: 12px; 
  margin-top: 15px; 
  flex-wrap: wrap;
}

.code-display .letter { 
  width: 55px; 
  height: 55px; 
  background: linear-gradient(135deg, var(--accent), #16A085);
  border-radius: 12px; 
  text-align: center; 
  line-height: 55px; 
  font-size: 1.8em; 
  font-weight: bold; 
  color: white;
  box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
}

.qr-container { 
  text-align: center; 
  margin: 35px 0;
  padding: 25px;
  background: linear-gradient(135deg, #FFF9E6, #FFF3CD);
  border-radius: 12px;
  border-left: 5px solid var(--warning);
}

.qr-container h3 {
  color: var(--warning);
  margin-top: 0;
}

.qr-container img { 
  max-width: 250px; 
  border: 4px solid var(--primary); 
  border-radius: 15px; 
  padding: 15px; 
  background: white;
  box-shadow: 0 8px 25px rgba(44, 62, 80, 0.2);
  margin: 20px 0;
}

.qr-instructions {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-top: 20px;
  border: 2px solid var(--warning);
  line-height: 1.8;
  color: var(--dark);
}

.qr-instructions strong {
  color: var(--warning);
}

footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px 0;
  border-top: 2px solid #ECF0F1;
  color: #7F8C8D;
  font-size: 0.9em;
}

footer a {
  color: #3498DB;
  text-decoration: none;
  font-weight: 500;
}

footer a:hover {
  text-decoration: underline;
}

@media (max-width: 768px) {
  body { font-size: 15px; padding: 10px; }
  .container { padding: 25px; border-radius: 15px; }
  h1 { font-size: 1.8em; }
  h2 { font-size: 1.4em; }
  .letter-box { width: 42px; height: 42px; line-height: 42px; font-size: 1.3em; margin: 4px;}
  .dragspace { padding: 15px; }
  button { padding: 12px 20px; font-size: 1em; }
  .steps-grid { grid-template-columns: 1fr;}
  .code-display .letter { width: 48px; height: 48px; line-height: 48px; font-size: 1.5em;}
  .timer-display { font-size: 2em; }
  .mode-selector { flex-direction: column; align-items: center; }
  .mode-card { width: 100%; max-width: 300px; }
}

@media (max-width: 480px) {
  body { font-size: 14px; }
  h1 { font-size: 1.5em; }
  .letter-box { width: 38px; height: 38px; line-height: 38px; font-size: 1.2em; margin: 3px;}
  .code-display .letter { width: 42px; height: 42px; line-height: 42px; font-size: 1.3em;}
  .intro-screen .start-btn { padding: 15px 35px; font-size: 1.2em; }
}
</style>
</head>
<body>
<div class="container" id="mainContainer">
  <!-- INTRO SCREEN -->
  <div id="introScreen" class="intro-screen">
    <h1>üéì Simulateur de Classe Flexible</h1>
    <h2>‚ú® Les Experts Flexibles</h2>
    
    <div class="welcome-text">
      <p><strong>Bienvenue dans ce simulateur de classe flexible.</strong></p>
      <p>Vous √™tes des <strong>experts</strong> ou allez le devenir. Des articles en ligne ou des ressources papier √† consulter, des codes √† d√©couvrir et un d√©fi final avant d'obtenir le bonus.</p>
      <p>üìã <strong>Consignes :</strong></p>
      <ul>
        <li>Vous pouvez commencer par vous pr√©senter et exprimer votre int√©r√™t pour la classe flexible</li>
        <li>Vous pouvez vous r√©partir les t√¢ches...</li>
        <li>Quand vous √™tes pr√™ts, <strong>d√©marrer le chrono</strong>, vous avez <strong>quinze minutes</strong></li>
      </ul>
      <p>üçÄ <strong>Bonne chance !</strong></p>
    </div>
    
    <div class="mode-selector">
      <div class="mode-card" onclick="selectMode('complete')">
        <div class="icon">üë•</div>
        <h3>Mode Complet</h3>
        <p>Toute l'√©quipe ensemble avec acc√®s √† tout</p>
      </div>
      <div class="mode-card" onclick="selectMode('pilot')">
        <div class="icon">üéØ</div>
        <h3>Mode Pilote</h3>
        <p>Pour celui qui valide les codes</p>
      </div>
      <div class="mode-card" onclick="selectMode('reader')">
        <div class="icon">üìö</div>
        <h3>Mode Lecteur</h3>
        <p>Pour ceux qui consultent les ressources</p>
      </div>
    </div>
    
    <button class="start-btn" onclick="startGame()">üöÄ D√©marrer l'exp√©rience</button>
  </div>
  
  <!-- MAIN GAME AREA (hidden initially) -->
  <div id="gameArea" style="display:none;">
    <h1>‚ú® Simulateur Classe Flexible</h1>
    <h2>Les Experts Flexibles</h2>
    
    <!-- Timer -->
    <div id="timerContainer" class="timer-container" style="display:none;">
      <div>‚è±Ô∏è <strong>Temps restant</strong></div>
      <div class="timer-display" id="timerDisplay">15:00</div>
      <div class="timer-bar">
        <div class="timer-bar-fill" id="timerBarFill" style="width:100%;"></div>
      </div>
    </div>
    
    <!-- XP & Badges -->
    <div class="xp-bar-container">
      <h3>üìä Progression de l'√©quipe</h3>
      <div class="xp-bar">
        <div class="xp-bar-fill" id="xpBarFill" style="width:0%;">
          <span id="xpText">0 / 600 XP</span>
        </div>
      </div>
      <div class="badges-container" id="badgesContainer"></div>
    </div>
    
    <div class="progress" id="progress">Lettres d√©bloqu√©es :</div>
    <div id="letters"></div>
    <div id="game"></div>
    
    <div class="notes-area">
      <h3 style="color:#2C3E50;">üìù Espace de prise de notes</h3>
      <textarea id="notes" placeholder="Notez ici vos r√©flexions, id√©es et observations..."></textarea>
      <button onclick="downloadNotes()">üì• T√©l√©charger mes notes</button>
    </div>
    
    <div id="scoring"></div>
    <div id="exportArea"></div>
  </div>
  
  <footer>
    <p>Application cr√©√©e par <strong>Am√©lie Silvert</strong></p>
    <p><a href="mailto:amelie.silvert@ac-lille.fr">amelie.silvert@ac-lille.fr</a></p>
  </footer>
</div>

<!-- Bonus Time Modal -->
<div id="bonusModal" class="bonus-time-modal" style="display:none;">
  <div class="bonus-time-content">
    <h2>‚ö†Ô∏è Plus que 2 minutes !</h2>
    <p><strong>Vous pouvez gagner 5 minutes suppl√©mentaires !</strong></p>
    <p>Pr√©venez l'animatrice et allez jeter un coup d'≈ìil aux groupes d'√† c√¥t√©.</p>
    <p>Si c'est fait, l'animatrice validera le temps suppl√©mentaire.</p>
    <button onclick="requestBonusTime()">‚úÖ Demander le bonus √† l'animatrice</button>
    <button onclick="declineBonusTime()" style="background: linear-gradient(135deg, #95A5A6, #7F8C8D);">‚ùå Continuer sans bonus</button>
  </div>
</div>

<script>
// === GAME STATE ===
let state = {
  step: 0, 
  score: 0, 
  xp: 0,
  letters: [], 
  parcours: [], 
  exportID: "",
  mode: "complete",
  timerStarted: false,
  timeRemaining: 900, // 15 minutes in seconds
  totalTime: 900,
  bonusRequested: false,
  bonusGranted: false
};

const badges = [
  {id: 1, icon: "üéØ", name: "Premier pas", unlocked: false},
  {id: 2, icon: "üìö", name: "Lecteur assidu", unlocked: false},
  {id: 3, icon: "üß©", name: "R√©solveur", unlocked: false},
  {id: 4, icon: "‚ö°", name: "Rapide", unlocked: false},
  {id: 5, icon: "üèÜ", name: "Expert", unlocked: false},
  {id: 6, icon: "üë•", name: "Collaborateur", unlocked: false}
];

// === AUDIO CONTEXT ===
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(frequency = 800, duration = 200) {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = frequency;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration/1000);
}

function playSuccessSound() {
  playBeep(523, 100);
  setTimeout(() => playBeep(659, 100), 100);
  setTimeout(() => playBeep(784, 200), 200);
}

function playWarningSound() {
  playBeep(400, 300);
  setTimeout(() => playBeep(400, 300), 350);
}

function playErrorSound() {
  playBeep(200, 500);
}

// === STEPS DATA ===
const steps = [
  {
    titre:"Sensibiliser l'√©quipe",
    xpReward: 100,
    keyword: {
      question: "Qu'est-ce qu'un am√©nagement de classe flexible peut tendre √† r√©duire chez les √©l√®ves ?",
      hint: "(2 mots attendus)",
      answer: "le stress"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Avant de r√©pondre, consultez cette ressource sur l'importance de l'am√©nagement de classe :",
      link: {url:"https://www.reseau-canope.fr/actualites/article/amenager-sa-classe-pour-servir-sa-pedagogie", text:"Am√©nager sa classe pour servir sa p√©dagogie (R√©seau Canop√©)"}
    },
    texte:"Un enseignant refuse de bouger les tables de sa classe et remet en cause l'int√©r√™t de la flexibilit√©. Quel argument est le plus efficace pour engager le dialogue ?",
    qcm: [
      {text:"¬´ La classe flexible est grav√©e dans le marbre, c'est un projet sp√©cifique. ¬ª", correct:false},
      {text:"¬´ La flexibilit√© favorise la collaboration et l'engagement des √©l√®ves. ¬ª", correct:true},
      {text:"¬´ On doit suivre la tendance, c'est le XXIe si√®cle ! ¬ª", correct:false},
    ],
    visuel:"https://cdn.pixabay.com/photo/2017/01/10/19/05/classroom-1963759_960_720.jpg"
  },
  {
    titre:"Organiser le projet",
    xpReward: 100,
    keyword: {
      question: "Dans le premier degr√©, quel outil pour planifier les t√¢ches des √©l√®ves peut √™tre utile dans le second degr√© aussi ?",
      hint: "(4 mots attendus)",
      answer: "le plan de travail"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Consultez cette ressource pour comprendre les √©tapes d'un projet de classe flexible :",
      link: {url:"https://bloghoptoys.fr/comment-reussir-votre-projet-de-classe-flexible/", text:"Comment r√©ussir votre projet de classe flexible ? (Blog Hop'Toys)"}
    },
    texte:"Organisez les √©tapes de d√©marrage d'une classe flexible dans l'ordre chronologique. Glissez chaque √©l√©ment dans la bonne position (une seule carte par √©tape).",
    dragtask: {
      items: [
         {id:"1", text:"R√©fl√©chir au projet et d√©finir les objectifs p√©dagogiques", cat:"etape1"},
         {id:"2", text:"Former l'√©quipe et mobiliser les enseignants", cat:"etape2"},
         {id:"3", text:"R√©cup√©rer ou acheter du mat√©riel au fur et √† mesure", cat:"etape3"},
         {id:"4", text:"Am√©nager la classe avec diff√©rentes zones", cat:"etape4"},
         {id:"5", text:"√âtablir des r√®gles claires avec les √©l√®ves", cat:"etape5"},
         {id:"6", text:"Observer et ajuster progressivement", cat:"etape6"},
         {id:"7", text:"Acheter du mat√©riel sans concertation", cat:"piege"},
         {id:"8", text:"Tout changer d'un coup sans test", cat:"piege"},
      ],
      cats: [
        {name: "√âtape 1", key:"etape1"},
        {name: "√âtape 2", key:"etape2"},
        {name: "√âtape 3", key:"etape3"},
        {name: "√âtape 4", key:"etape4"},
        {name: "√âtape 5", key:"etape5"},
        {name: "√âtape 6", key:"etape6"}
      ]
    },
    visuel:"https://images.unsplash.com/photo-1523580846011-d3a5bc25702b"
  },
  {
    titre:"Utilit√© p√©dagogique",
    xpReward: 100,
    keyword: {
      question: "Quel est le conseil d'Am√©lie, l'enseignante de lettres pour se lancer : doit-on tout changer dans sa p√©dagogie ?",
      hint: "(r√©ponse : oui ou non)",
      answer: "non"
    },
    discussion: "üí¨ Apr√®s avoir visionn√© cette vid√©o, discutez des points qui vous ont marqu√©s. Par exemple, quels sont vos ressentis face √† la pr√©sentation de la classe d'Am√©lie.",
    resources: {
      title: "üìö Ressource √† consulter (vid√©o)",
      intro: "D√©couvrez les b√©n√©fices p√©dagogiques de la classe flexible :",
      link: {url:"https://canotech.fr/a/la-classe-flexible-pour-faire-classe-a-tous-les-eleves", text:"La classe flexible pour faire classe √† tous les √©l√®ves (CanoTech)"}
    },
    texte:"Cochez les avantages p√©dagogiques document√©s de la classe flexible :",
    qcm: [
      {text:"Plus grande motivation des √©l√®ves", correct:true},
      {text:"Meilleur climat de classe", correct:true},
      {text:"Automaticit√© des r√©sultats √©lev√©s", correct:false},
      {text:"Favorise l'autonomie", correct:true},
      {text:"Les √©l√®ves ne font plus de bruit", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2017/09/09/21/13/class-2732253_960_720.jpg"
  },
  {
    titre:"Parent inquiet",
    xpReward: 100,
    keyword: {
      question: "Dans l'article d'Archiclasse, dans la partie t√©moignage d'Anne-C√©cile Call√©jon, quel sport est utilis√© pour cr√©er la m√©taphore du travail d'√©quipe ?",
      hint: "(2 mots attendus)",
      answer: "le curling"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "D√©couvrez comment impliquer et accompagner les parents :",
      link: {url:"https://archiclasse.education.fr/Un-projet-accompagne-est-toujours-un-projet-reussi", text:"Un projet accompagn√© : impliquer parents et usagers (Archiclasse)"}
    },
    texte:`Un parent vient vous voir, persuad√© que la classe flexible ¬´ n'est que du d√©sordre ¬ª. Que lui montrez-vous en priorit√© ?`,
    qcm:[
      {text:"Des photos d'√©l√®ves concentr√©s en groupe et en autonomie.", correct:true},
      {text:"Votre budget mobilier.", correct:false},
      {text:"Des statistiques nationales.", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2015/09/18/21/13/classroom-942422_960_720.jpg"
  },
  {
    titre:"Limiter les nuisances",
    xpReward: 100,
    keyword: {
      question: "Quel mot-clef dans cet article pour laisser l'√©l√®ve √† BEP se sentir bien dans la classe ? Le professeur lui laisse ... de son espace de travail.",
      hint: "(2 mots attendus)",
      answer: "le choix"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "D√©couvrez comment adapter la classe flexible et g√©rer le bruit :",
      link: {url:"https://www.classe-de-demain.fr/accueil/classe-flexible/comment-adapter-sa-classe-flexible-aux-eleves-aux-besoins-educatifs-particuliers-bep-episode-4", text:"Adapter sa classe flexible et g√©rer le bruit (Classe de Demain)"}
    },
    texte:`Un coll√®gue d'√† c√¥t√© se plaint du bruit. Quelle action prioritaire ?`,
    qcm:[
      {text:"Poser des tapis, panneaux acoustiques, et r√©guler les d√©placements.", correct:true},
      {text:"Fermer d√©finitivement la salle.", correct:false},
      {text:"Accuser l'enseignant flexible.", correct:false}
    ],
    visuel:"https://images.unsplash.com/photo-1524995997946-a1c2e315a42f"
  },
  {
    titre:"√âvoluer dans sa posture",
    xpReward: 100,
    keyword: {
      question: "Comment D√©fine fonctionne pour la r√©partition des √©l√®ves sur diff√©rentes assises ? Par un planning ...",
      hint: "(1 mot attendu)",
      answer: "hebdomadaire"
    },
    resources: {
      title: "üìö Ressource √† consulter",
      intro: "Explorez le changement de posture de l'enseignant :",
      link: {url:"https://bloghoptoys.fr/comment-gerer-les-differentes-assises-de-la-classe/", text:"G√©rer les assises et la posture en classe flexible (Blog Hop'Toys)"}
    },
    texte:"Cochez les attitudes professionnelles favorisant la posture de guide :",
    qcm:[
      {text:"Encourager l'autonomie et la prise d'initiative", correct:true},
      {text:"Laisser les √©l√®ves seuls face √† la t√¢che", correct:false},
      {text:"Varier les modalit√©s d'animation", correct:true},
      {text:"En variant les propositions d'assises aux √©l√®ves", correct:true},
      {text:"Sanctionner ceux qui bougent trop souvent", correct:false}
    ],
    visuel:"https://cdn.pixabay.com/photo/2018/01/20/08/33/laptop-3095990_960_720.jpg"
  }
];

// === MODE SELECTION ===
function selectMode(mode) {
  const cards = document.querySelectorAll('.mode-card');
  cards.forEach(card => card.classList.remove('selected'));
  event.target.closest('.mode-card').classList.add('selected');
  state.mode = mode;
  localStorage.setItem('classFlexMode', mode);
}

// === TIMER FUNCTIONS ===
let timerInterval = null;

function startTimer() {
  if(state.timerStarted) return;
  
  state.timerStarted = true;
  document.getElementById('timerContainer').style.display = 'block';
  
  timerInterval = setInterval(() => {
    state.timeRemaining--;
    
    updateTimerDisplay();
    
    // Warning at 2 minutes (120 seconds)
    if(state.timeRemaining === 120 && !state.bonusRequested) {
      showBonusModal();
      playWarningSound();
    }
    
    // Time's up
    if(state.timeRemaining <= 0) {
      clearInterval(timerInterval);
      gameOver();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(state.timeRemaining / 60);
  const seconds = state.timeRemaining % 60;
  const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
  document.getElementById('timerDisplay').textContent = display;
  
  const percentage = (state.timeRemaining / state.totalTime) * 100;
  document.getElementById('timerBarFill').style.width = percentage + '%';
  
  const timerContainer = document.getElementById('timerContainer');
  if(state.timeRemaining <= 120) {
    timerContainer.classList.add('timer-warning');
  }
}

function showBonusModal() {
  document.getElementById('bonusModal').style.display = 'flex';
}

function requestBonusTime() {
  state.bonusRequested = true;
  document.getElementById('bonusModal').style.display = 'none';
  
  // Simulate animator validation (in real scenario, animator would click a button)
  const confirmed = confirm("üéì ANIMATRICE : Confirmez-vous que le groupe a observ√© les autres √©quipes ?");
  
  if(confirmed) {
    state.bonusGranted = true;
    state.timeRemaining += 300; // Add 5 minutes
    state.totalTime += 300;
    playSuccessSound();
    alert("‚úÖ Temps bonus accord√© ! +5 minutes");
  } else {
    alert("‚ùå Continuez avec le temps restant !");
  }
}

function declineBonusTime() {
  state.bonusRequested = true;
  document.getElementById('bonusModal').style.display = 'none';
}

function gameOver() {
  playErrorSound();
  const restart = confirm("‚è∞ Temps √©coul√© ! Voulez-vous recommencer depuis le d√©but ?");
  if(restart) {
    location.reload();
  }
}

// === XP & BADGES ===
function addXP(amount) {
  state.xp += amount;
  const percentage = Math.min((state.xp / 600) * 100, 100);
  document.getElementById('xpBarFill').style.width = percentage + '%';
  document.getElementById('xpText').textContent = `${state.xp} / 600 XP`;
  
  checkBadgeUnlocks();
}

function checkBadgeUnlocks() {
  if(state.step >= 1 && !badges[0].unlocked) unlockBadge(0);
  if(state.xp >= 200 && !badges[1].unlocked) unlockBadge(1);
  if(state.step >= 3 && !badges[2].unlocked) unlockBadge(2);
  if(state.timeRemaining > 600 && state.step >= 3 && !badges[3].unlocked) unlockBadge(3);
  if(state.step >= 6 && !badges[4].unlocked) unlockBadge(4);
  if(state.bonusGranted && !badges[5].unlocked) unlockBadge(5);
}

function unlockBadge(index) {
  badges[index].unlocked = true;
  playSuccessSound();
  renderBadges();
}

function renderBadges() {
  const container = document.getElementById('badgesContainer');
  container.innerHTML = badges.map(b => `
    <div class="badge ${b.unlocked ? 'unlocked' : ''}">
      ${b.icon}
      <span class="badge-tooltip">${b.name}</span>
    </div>
  `).join('');
}

// === GAME START ===
function startGame() {
  if(!state.mode) {
    alert("Veuillez s√©lectionner un mode avant de d√©marrer !");
    return;
  }
  
  document.getElementById('introScreen').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  
  renderBadges();
  startTimer();
  showStep();
}

// === NORMALIZE TEXT ===
function normalizeText(text){
  return text.toLowerCase().trim().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
}

// === UPDATE LETTERS ===
function updateLetters(){
  const container = document.getElementById('letters');
  if(!container) return;
  container.innerHTML = '';
  'SOUPLE'.split('').forEach((l,i)=> {
    const box = document.createElement('span');
    const isUnlocked = state.letters.includes(l);
    box.className = 'letter-box'+(isUnlocked?' unlocked':' hidden');
    box.textContent = isUnlocked ? l : '?';
    container.appendChild(box);
  });
}

// === SHOW CODE MESSAGE ===
function showCodeMessage(){
  const content = document.getElementById('game');
  content.innerHTML = '';
  
  const successDiv = document.createElement('div');
  successDiv.className = 'success-message';
  
  const letter = "SOUPLE"[state.step];
  successDiv.innerHTML = `
    <h3>üéâ Bravo ! Vous avez d√©bloqu√© la lettre "${letter}"</h3>
    <div class="code-display">
      <p><strong>Code actuel :</strong></p>
      <div class="letters">
        ${state.letters.map(l => `<span class="letter">${l}</span>`).join('')}
      </div>
    </div>
  `;
  
  const continueBtn = document.createElement('button');
  continueBtn.textContent = "Continuer ‚Üí";
  continueBtn.className = 'continue-btn';
  continueBtn.onclick = ()=> {
    state.step++;
    showStep();
  };
  
  successDiv.appendChild(continueBtn);
  content.appendChild(successDiv);
}

// === BACK BUTTON ===
function addBackButton(container){
  if(state.step > 0){
    const backBtn = document.createElement('button');
    backBtn.textContent = "‚Üê Retour";
    backBtn.className = 'back-btn';
    backBtn.onclick = goBack;
    container.insertBefore(backBtn, container.firstChild);
  }
}

function goBack(){
  if(state.step > 0){
    state.step--;
    if(state.letters.length > state.step){
      state.letters.pop();
      state.parcours.pop();
    }
    showStep();
  }
}

// === SHOW STEP ===
function showStep(){
  updateLetters();
  const content = document.getElementById('game');
  if(!content) return;
  content.innerHTML = '';
  
  if(state.step >= steps.length){
    showEnd();
    return;
  }
  
  const s = steps[state.step];
  addBackButton(content);
  
  if(state.mode === 'pilot') {
    showPilotInterface(s, content);
  } else if(state.mode === 'reader') {
    showReaderInterface(s, content);
  } else {
    showResourcesWithKeyword(s, content);
  }
}

// === PILOT INTERFACE ===
function showPilotInterface(s, container) {
  const pilotDiv = document.createElement('div');
  pilotDiv.className = 'pilot-interface';
  pilotDiv.innerHTML = `
    <h3>üéØ Interface Pilote - ${s.titre}</h3>
    <p><strong>Votre r√¥le :</strong> Entrez les codes et validez les r√©ponses de votre √©quipe.</p>
    <p>Les autres membres de l'√©quipe consultent les ressources et vous communiquent les r√©ponses.</p>
    <hr>
    <h4>Entrez le code d√©couvert :</h4>
    <div class="code-input-group">
      <input type="text" class="code-input" maxlength="1" id="codeInput">
    </div>
    <button onclick="validatePilotCode()">Valider le code</button>
    <hr>
    <p><em>üí° Astuce : Communiquez avec votre √©quipe pour obtenir les bonnes r√©ponses !</em></p>
  `;
  container.appendChild(pilotDiv);
}

function validatePilotCode() {
  const input = document.getElementById('codeInput');
  const expectedLetter = "SOUPLE"[state.step];
  
  if(input.value.toUpperCase() === expectedLetter) {
    playSuccessSound();
    alert("‚úÖ Code correct !");
    validateStep();
  } else {
    playErrorSound();
    alert("‚ùå Code incorrect. V√©rifiez avec votre √©quipe.");
  }
}

// === READER INTERFACE ===
function showReaderInterface(s, container) {
  showResourcesWithKeyword(s, container);
  
  const readerNote = document.createElement('div');
  readerNote.className = 'discussion-box';
  readerNote.innerHTML = `
    <h4>üìö Mode Lecteur/Chercheur</h4>
    <p>Votre mission : Consultez les ressources, r√©pondez aux questions, et communiquez les codes au pilote de votre √©quipe.</p>
  `;
  container.insertBefore(readerNote, container.firstChild);
}

// === SHOW RESOURCES WITH KEYWORD ===
function showResourcesWithKeyword(s, container){
  const titleDiv = document.createElement('div');
  titleDiv.innerHTML = `<h2>${s.titre}</h2>`;
  container.appendChild(titleDiv);
  
  const resDiv = document.createElement('div');
  resDiv.className = 'resources';
  let html = `<h3>${s.resources.title}</h3>`;
  if(s.resources.intro){
    html += `<p>${s.resources.intro}</p>`;
  }
  html += `<a href="${s.resources.link.url}" target="_blank">${s.resources.link.text}</a>`;
  resDiv.innerHTML = html;
  container.appendChild(resDiv);
  
  if(s.keyword){
    const keywordDiv = document.createElement('div');
    keywordDiv.className = 'keyword-input';
    keywordDiv.innerHTML = `
      <h4>‚ùì Question de compr√©hension</h4>
      <p><strong>${s.keyword.question}</strong></p>
      <p class="keyword-hint">${s.keyword.hint}</p>
      <input type="text" id="keywordInput" placeholder="Votre r√©ponse...">
      <button id="validateKeyword">Valider la lecture</button>
    `;
    container.appendChild(keywordDiv);
    
    setTimeout(() => {
      const validateBtn = document.getElementById('validateKeyword');
      const inputField = document.getElementById('keywordInput');
      
      if(validateBtn && inputField){
        validateBtn.onclick = ()=> {
          const userInput = inputField.value;
          if(normalizeText(userInput) === normalizeText(s.keyword.answer)){
            playSuccessSound();
            if(s.discussion){
              keywordDiv.style.display = 'none';
              const discussionDiv = document.createElement('div');
              discussionDiv.className = 'discussion-box';
              discussionDiv.innerHTML = `<h4>üí¨ Temps d'√©change</h4><p>${s.discussion}</p>`;
              const continueBtn = document.createElement('button');
              continueBtn.textContent = "Continuer vers l'activit√© ‚Üí";
              continueBtn.className = 'continue-btn';
              continueBtn.onclick = ()=> showActivity(s, container);
              discussionDiv.appendChild(continueBtn);
              container.appendChild(discussionDiv);
            } else {
              showActivity(s, container);
            }
          } else {
            playErrorSound();
            alert("R√©ponse incorrecte. Veuillez relire la ressource et r√©essayer.");
          }
        };
        
        inputField.addEventListener('keypress', (e) => {
          if(e.key === 'Enter'){
            validateBtn.click();
          }
        });
      }
    }, 100);
  }
}

// === SHOW ACTIVITY ===
function showActivity(s, container){
  if(state.mode === 'pilot') return; // Pilotes ne font pas les activit√©s
  
  container.innerHTML = '';
  addBackButton(container);
  
  const activityDiv = document.createElement('div');
  activityDiv.innerHTML = `<h2>${s.titre}</h2><div>${s.texte}</div>${s.visuel?`<img src="${s.visuel}" alt="">`:''}`;
  container.appendChild(activityDiv);
  
  if(s.qcm){
    const qform = document.createElement('form');
    qform.className = 'qcm';
    s.qcm.forEach((opt, idx)=>{
      const lab=document.createElement('label');
      const cb=document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'qcm'+state.step;
      cb.value=idx;
      lab.appendChild(cb);
      lab.append(' '+opt.text);
      qform.appendChild(lab);
    });
    const valBtn = document.createElement('button');
    valBtn.textContent = "Valider";
    valBtn.type = 'button';
    valBtn.onclick = ()=>validateQCM(s.qcm, qform);
    qform.appendChild(valBtn);
    container.appendChild(qform);
  }
  
  if(s.dragtask){
    drawDragTask(s.dragtask, container);
  }
}

// === VALIDATE QCM ===
function validateQCM(qcm, form){
  let allCorrect=true;
  const inputs = Array.from(form.querySelectorAll('input'));
  
  inputs.forEach((inp,i)=>{
    let isChecked = inp.checked;
    let shouldBeChecked = qcm[i].correct;
    if(isChecked !== shouldBeChecked) allCorrect = false;
  });
  
  if(allCorrect) {
    playSuccessSound();
    let pointsForStep = 3;
    if(state.step === 2) pointsForStep = 4;
    
    state.score += pointsForStep;
    form.querySelector('button').disabled = true;
    validateStep();
  } else {
    playErrorSound();
    alert("Essayez encore pour trouver la meilleure r√©ponse !");
  }
}

// === DRAG TASK ===
function drawDragTask(task, container){
  let srcItems=task.items.map(it=>({...it, placed:false}));
  let cats=task.cats.map(c=>({...c, currentItem: null}));
  
  let dragspace = document.createElement('div');
  dragspace.className = 'dragspace';
  dragspace.id = 'dragSrc';
  dragspace.innerHTML = '<strong>√Ä placer :</strong><br>';
  
  srcItems.sort(() => Math.random() - 0.5);
  
  srcItems.forEach(it=>{
    let span= document.createElement('span');
    span.className='draggable';
    span.textContent=it.text;
    span.draggable=true;
    span.dataset.id=it.id;
    span.ondragstart= e=> e.dataTransfer.setData('id', it.id);
    dragspace.appendChild(span);
  });
  container.appendChild(dragspace);

  let stepsGrid = document.createElement('div');
  stepsGrid.className = 'steps-grid';
  
  cats.forEach(cat=>{
    let dz=document.createElement('div');
    dz.className='dragspace single';
    dz.innerHTML = `<strong>${cat.name}</strong><br>`;
    dz.dataset.cat = cat.key;
    
    dz.ondragover = e=>e.preventDefault();
    dz.ondrop= e=>{
      e.preventDefault();
      let id = e.dataTransfer.getData('id');
      let item = srcItems.find(o=>o.id==id);
      let elem = document.querySelector('[data-id="'+id+'"]');
      
      if(item && elem){
        if(cat.currentItem){
          let oldElem = dz.querySelector('.draggable');
          if(oldElem){
            dragspace.appendChild(oldElem);
            cat.currentItem.placed = false;
          }
        }
        
        cats.forEach(c=>{
          if(c.currentItem && c.currentItem.id === item.id) c.currentItem = null;
        });
        
        dz.appendChild(elem);
        cat.currentItem = item;
        item.placed = true;
      }
    };
    stepsGrid.appendChild(dz);
  });
  container.appendChild(stepsGrid);
  
  const btnGroup = document.createElement('div');
  btnGroup.className = 'button-group';
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "üîÑ R√©initialiser";
  resetBtn.className = 'reset-btn';
  resetBtn.onclick = ()=>{
    cats.forEach(c=>{
      if(c.currentItem){
        let elem = document.querySelector('[data-id="'+c.currentItem.id+'"]');
        if(elem) dragspace.appendChild(elem);
        c.currentItem.placed = false;
        c.currentItem = null;
      }
    });
  };
  btnGroup.appendChild(resetBtn);
  
  const valBtn = document.createElement('button');
  valBtn.textContent = "Valider mon organisation";
  valBtn.onclick = ()=>{
    let filledCount = cats.filter(c=>c.currentItem !== null).length;
    if(filledCount !== 6){
      alert("Veuillez placer exactement 6 √©l√©ments (un par √©tape) avant de valider !");
      return;
    }
    
    let hasPiege = cats.some(c=>c.currentItem && c.currentItem.cat==='piege');
    let allCorrect = cats.every(c=>c.currentItem && c.currentItem.cat===c.key);
    
    if(allCorrect && !hasPiege) {
      playSuccessSound();
      state.score += 4;
      valBtn.disabled = true;
      resetBtn.disabled = true;
      validateStep();
    } else {
      playErrorSound();
      if(hasPiege){
        alert("Attention : certaines actions ne sont pas recommand√©es pour d√©marrer une classe flexible. Acheter du mat√©riel sans concertation ou tout changer d'un coup sont des erreurs √† √©viter. R√©essayez !");
      } else {
        alert("Certaines √©tapes ne sont pas dans le bon ordre chronologique. R√©essayez !");
      }
    }
  };
  btnGroup.appendChild(valBtn);
  container.appendChild(btnGroup);
}

// === VALIDATE STEP ===
function validateStep(){
  const letter="SOUPLE"[state.step];
  state.letters.push(letter);
  state.parcours.push(steps[state.step].titre);
  
  addXP(steps[state.step].xpReward);
  
  updateLetters();
  showCodeMessage();
}

// === SHOW END ===
function showEnd(){
  clearInterval(timerInterval);
  updateLetters();
  
  let res = document.getElementById('game');
  if(!res) return;
  
  let timeBonus = 0;
  if(state.timeRemaining > 0) {
    timeBonus = Math.floor(state.timeRemaining / 60);
  }
  
  let finalScore = state.score + timeBonus;
  let perf = finalScore >= 18 ? "üèÜ Transformation exemplaire !" : (finalScore>=12? "‚úÖ R√©ussite solide" : "üìà Progr√®s √† faire !");
  
  res.innerHTML = `<h2>üéâ F√©licitations, vous avez d√©bloqu√© toutes les lettres !</h2>
    <div class="code-display">
      <p><strong>Code final : SOUPLE</strong></p>
      <div class="letters">
        ${'SOUPLE'.split('').map(l => `<span class="letter">${l}</span>`).join('')}
      </div>
    </div>
    <div id="scoring">
      <p>Score d'activit√©s : ${state.score}/20</p>
      <p>Bonus de temps : +${timeBonus} points</p>
      <p><strong>Score final : ${finalScore}/25</strong></p>
      <p><b>${perf}</b></p>
      <p>XP total : ${state.xp} / 600</p>
    </div>
    <div class="qr-container">
      <h3>üéÅ D√©couvrez votre r√©compense !</h3>
      <img src="https://silverteacher.github.io/simulateurflexible/qrcode.png" alt="QR Code R√©compense">
      <div class="qr-instructions">
        <p><strong>üìã Instructions pour acc√©der √† la ressource BONUS :</strong></p>
        <p>Vous pouvez maintenant ouvrir votre enveloppe et r√©cup√©rer le QR code physique. Les lettres du code d√©couvertes (S-O-U-P-L-E) seront √† cocher sur le document pour rendre le QR code actif et acc√©der √† la ressource BONUS exclusive !</p>
      </div>
    </div>
    <button id="export">üì• Exporter votre parcours</button>`;
  
  document.getElementById('export').onclick = function(){
    let id = "CF"+Date.now();
    state.exportID = id;
    let notes = document.getElementById('notes').value;
    let txt = `ID: ${id}\nMode: ${state.mode}\nScore: ${finalScore}/25\nR√©sultat: ${perf}\nXP: ${state.xp}/600\nParcours: ${state.parcours.join(', ')}\n\n=== NOTES ===\n${notes}`;
    let blob = new Blob([txt], {type:"text/plain"});
    let a = document.createElement('a');
    a.download= 'ClasseFlexible_parcours_'+id+'.txt';
    a.href= URL.createObjectURL(blob);
    a.click();
  };
}

// === DOWNLOAD NOTES ===
function downloadNotes(){
  let notes = document.getElementById('notes').value;
  if(!notes.trim()){
    alert("Aucune note √† t√©l√©charger !");
    return;
  }
  let blob = new Blob([notes], {type:"text/plain"});
  let a = document.createElement('a');
  a.download= 'MesNotes_ClasseFlexible.txt';
  a.href= URL.createObjectURL(blob);
  a.click();
}

// === INIT ===
window.addEventListener('DOMContentLoaded', function(){
  // Check if mode already selected (for multi-device sync)
  const savedMode = localStorage.getItem('classFlexMode');
  if(savedMode) {
    state.mode = savedMode;
  }
});
</script>
</body>
</html>
